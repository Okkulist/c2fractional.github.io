<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CÂ² Fractional Management â€” Quotation</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><text y='28' font-size='28'>ðŸ“Š</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#f5f3f0}
input:focus,textarea:focus{outline:none;border-color:#333 !important}
button{cursor:pointer}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px}
.modal-box{background:#fff;border-radius:12px;padding:24px;max-width:600px;width:100%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.2)}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const { useState, useMemo, useRef, useCallback } = React;

const PW = "aboshakraistheog";
const RATE = 1200;
const MIN_RETAINER = 100000;
const REV = 120000000;
const FX = 47;
const M1_CAP = 160;
const M1_FIREFIGHT = 80;

const D = { finance:{l:"Finance & Accounting",c:"#1e40af",bg:"#eff6ff",bdr:"#bfdbfe"}, ops:{l:"Operations & Commercial",c:"#92400e",bg:"#fffbeb",bdr:"#fde68a"}, hr:{l:"HR & People",c:"#7c3aed",bg:"#faf5ff",bdr:"#ddd6fe"}, deals:{l:"Deal Negotiations",c:"#0f766e",bg:"#f0fdfa",bdr:"#99f6e4"} };
const T = { quick:{l:"Quick Win",c:"#16653a",bg:"#f0fdf4",bdr:"#bbf7d0",tag:"#dcfce7",ico:"âš¡"}, medium:{l:"Medium Win",c:"#a16207",bg:"#fefce8",bdr:"#fde68a",tag:"#fef9c3",ico:"ðŸ”§"}, moon:{l:"Moonshot",c:"#b91c1c",bg:"#fef2f2",bdr:"#fecaca",tag:"#fee2e2",ico:"ðŸš€"} };
const IMP = { high:{l:"High",c:"#dc2626",n:3}, med:{l:"Medium",c:"#ea580c",n:2}, low:{l:"Low",c:"#ca8a04",n:1} };
const PRIO = {
  rev:{l:"Revenue",ico:"ðŸ“ˆ",c:"#059669",bg:"#ecfdf5",bdr:"#6ee7b7",tag:"#d1fae5",short:"REV"},
  cost:{l:"Cost Reduction",ico:"âœ‚ï¸",c:"#dc2626",bg:"#fef2f2",bdr:"#fca5a5",tag:"#fee2e2",short:"COST"},
  cash:{l:"Cash Collection",ico:"ðŸ’µ",c:"#1e40af",bg:"#eff6ff",bdr:"#93c5fd",tag:"#dbeafe",short:"CASH"}
};
const PRIO_ORDER = {rev:0,cost:1,cash:2};

const BRANCHES = ["Korba","Mohandessin","Maadi","Zamalek","Nasr City","Heliopolis","New Cairo","6th of October"];
const MONTHS_LIST = ["Jan 2026","Feb 2026","Mar 2026","Apr 2026","May 2026","Jun 2026"];

// â•â•â• TASKS â€” dependency-ordered â•â•â•
// Dependency rule: task.w[0] must be >= max(dep.w[1]) + 1 where possible
const INITIAL_TASKS = [
  // â”€â”€ B1: Financial Visibility & Controls â”€â”€
  // W1 foundation â€” no deps
  { id:3,b:"B1",name:"Bank Statement Collection & Reconciliation",dept:"finance",tier:"quick",hrs:2,w:[1,1],impact:"med",prio:"cash",desc:"Gather all bank records for full reconciliation. Unreconciled accounts hide embezzlement, duplicate payments, missing deposits.",pnl:"Uncovers 1â€“3% unrecorded transactions distorting P&L.",bs:"Enables accurate cash position. Identifies unrecorded liabilities.",cf:"Foundation of cash flow accuracy. Gap between bank and book = pure risk.",deps:[],enables:[4,36]},
  { id:5,b:"B1",name:"Fixed Assets Count (All Locations)",dept:"finance",tier:"quick",hrs:8,w:[1,2],impact:"med",prio:"cost",desc:"Physically verify every asset against register. Phantom assets inflate BS; unregistered assets have no insurance.",pnl:"Corrects depreciation by 5â€“15%. Removes ghost asset expenses.",bs:"Direct BS correction â€” aligns book value to physical reality.",cf:"Eliminates over-depreciation cash drag. Identifies disposal proceeds.",deps:[],enables:[6]},
  { id:7,b:"B1",name:"2025 Budget vs. Actual Review",dept:"finance",tier:"quick",hrs:12,w:[1,2],impact:"med",prio:"cost",desc:"Compare budget to actual for 2025. Variances reveal broken assumptions and uncontrolled spending.",pnl:"Identifies 3â€“7% controllable cost overruns.",bs:"Reveals capex over/under budget.",cf:"Compares cash budget to actual cash position.",deps:[],enables:[]},
  { id:8,b:"B1",name:"Food Costing & Recipe Pricing Audit",dept:"finance",tier:"quick",hrs:16,w:[1,3],impact:"high",prio:"cost",desc:"Visit every branch, measure actual recipes vs. system. The #1 margin lever â€” wrong recipe costs = wrong menu prices.",pnl:"2â€“5 pp food cost reduction. On EGP 120M, that's EGP 2.4Mâ€“6M/year.",bs:"Corrects inventory valuation. Identifies obsolete stock.",cf:"Faster inventory turnover. Reduces cash trapped in excess stock 10â€“20%.",deps:[],enables:[12,21,25]},
  // W1 â†’ W2 chain
  { id:4,b:"B1",name:"Register All Transactions on System",dept:"finance",tier:"quick",hrs:6,w:[1,2],impact:"high",prio:"cash",desc:"Force every transaction through accounting. Off-book activity is the fastest path to cash leakage.",pnl:"Captures 2â€“5% unrecorded revenue. Eliminates invisible expenses.",bs:"Corrects AR/AP balances. Ensures all liabilities recognised.",cf:"Closes gap between actual and recorded cash flow.",deps:[3],enables:[13,36]},
  { id:36,b:"B1",name:"Accrued Revenue Collection from Branches",dept:"finance",tier:"quick",hrs:8,w:[2,3],impact:"high",prio:"cash",desc:"Identify and collect all accrued but uncollected revenues from branches.",pnl:"Recovers 1â€“4% of branch revenue previously unrecorded.",bs:"Converts accrued revenue asset into cash.",cf:"Immediate cash injection. On EGP 120M, even 1% = EGP 1.2M.",deps:[3,4],enables:[]},
  // W2â€“W4: P&L per Branch first (requires 1 month of clean data)
  { id:2,b:"B1",name:"P&L per Branch",dept:"finance",tier:"medium",hrs:10,w:[4,6],impact:"high",prio:"cost",desc:"Break profitability to branch level. Requires ~1 month of clean transaction data and food costing baseline. This comes BEFORE the consolidated view â€” you need branches working correctly first.",pnl:"Exposes 5â€“15% profit variance. Enables targeted intervention on underperformers.",bs:"Identifies excess inventory and understated liabilities per branch.",cf:"Maps cash generation by location. Reveals cash-subsidised branches.",deps:[4,8],enables:[1,15,27]},
  // W6+: Consolidated P&L depends on branch P&Ls being stable
  { id:1,b:"B1",name:"Consolidated P&L Report",dept:"finance",tier:"medium",hrs:10,w:[6,8],impact:"high",prio:"cost",desc:"Consolidate across all branches once each branch P&L is validated. Built bottom-up â€” not top-down. Branch-level accuracy comes first.",pnl:"Creates group-level measurement system. Identifies 5â€“15% profit variance between branches.",bs:"First accurate balance sheet baseline. Corrects retained earnings.",cf:"Identifies cash vs. accrual gaps. Reveals where cash is trapped.",deps:[2,5],enables:[6,15,16]},
  // W7+: Full financial picture â€” deps on consolidated P&L
  { id:6,b:"B1",name:"Financial Position Statement",dept:"finance",tier:"medium",hrs:8,w:[7,8],impact:"high",prio:"cash",desc:"Definitive balance sheet snapshot â€” requires reconciled bank, registered transactions, fixed assets, and consolidated P&L.",pnl:"Validates P&L accuracy via BS cross-check.",bs:"This IS the balance sheet. First accurate snapshot â€” possibly ever.",cf:"Derives cash flow statement from BS movements. Shows free cash flow.",deps:[1,3,5],enables:[]},

  // â”€â”€ B2: Cost & Revenue Deep-Dive â”€â”€
  // W2: stock take right after transactions registered
  { id:13,b:"B2",name:"Full Stock Take (All Locations)",dept:"finance",tier:"medium",hrs:16,w:[2,3],impact:"high",prio:"cost",desc:"Physical count of every item in every location. Gap between book and physical = pure loss.",pnl:"1â€“3% COGS reduction from shrinkage control.",bs:"Direct inventory adjustment. May require write-down of damaged/obsolete stock.",cf:"Stops ongoing cash drain from pilferage.",deps:[4],enables:[14,22,23]},
  // W3: menu costing after food audit
  { id:12,b:"B2",name:"Menu Costing Full Review",dept:"finance",tier:"medium",hrs:12,w:[3,5],impact:"high",prio:"cost",desc:"Re-cost every menu item including sub-recipes, garnishes, packaging.",pnl:"2â€“4% gross margin improvement.",bs:"Corrects WIP inventory valuation.",cf:"Better margin = more cash per transaction.",deps:[8],enables:[25]},
  { id:20,b:"B2",name:"Purchases Analysis 2026 Monthly",dept:"finance",tier:"medium",hrs:8,w:[3,5],impact:"med",prio:"cost",desc:"Analyse procurement patterns â€” over-ordering, supplier pricing creep, purchasing inefficiencies.",pnl:"3â€“6% procurement savings.",bs:"Identifies excess inventory for liquidation.",cf:"Reduces cash tied in over-ordering.",deps:[4],enables:[]},
  { id:21,b:"B2",name:"Staff Meal Treatment & Policy",dept:"finance",tier:"medium",hrs:4,w:[3,4],impact:"low",prio:"cost",desc:"Define staff meal rules and tracking.",pnl:"0.5â€“1.5% food cost reduction.",bs:"Reclassifies hidden cost. Improves inventory accuracy.",cf:"Reduces uncontrolled food consumption draining inventory cash.",deps:[8],enables:[28]},
  // W7+: Revenue & expense analysis after branch P&Ls exist
  { id:15,b:"B2",name:"Revenue Analysis 2025/26 per Branch",dept:"finance",tier:"medium",hrs:12,w:[7,9],impact:"high",prio:"rev",desc:"Deep revenue trends by month, branch, category. Requires branch P&L baseline.",pnl:"3â€“8% revenue uplift from demand alignment.",bs:"Informs asset allocation decisions.",cf:"Reveals cash generation patterns by period.",deps:[2],enables:[]},
  { id:16,b:"B2",name:"Detailed Expenses per Branch",dept:"finance",tier:"medium",hrs:12,w:[7,9],impact:"high",prio:"cost",desc:"Line-by-line expense breakdown per branch. Requires consolidated P&L for context.",pnl:"5â€“12% cost reduction on outlier categories.",bs:"May reveal unrecorded liabilities.",cf:"Targets exact expense lines consuming excess cash.",deps:[1,2],enables:[]},

  // â”€â”€ B3: Operational SOPs & Controls â”€â”€
  // W1: immediate ops quick wins â€” no financial deps
  { id:9,b:"B3",name:"Menu Review & Optimisation",dept:"ops",tier:"quick",hrs:8,w:[1,2],impact:"high",prio:"rev",desc:"Analyse menu for dead items, cannibalisation, complexity.",pnl:"2â€“4% revenue uplift. 1â€“2% food cost reduction.",bs:"Reduces raw material SKUs â†’ lower inventory.",cf:"Faster inventory turns, fewer slow-moving items.",deps:[],enables:[10]},
  { id:24,b:"B3",name:"Sales Mix Report per Branch",dept:"ops",tier:"quick",hrs:10,w:[1,2],impact:"high",prio:"rev",desc:"Track what each branch sells, at what margin.",pnl:"1â€“3% margin improvement via menu engineering.",bs:"Informs inventory stocking decisions.",cf:"Higher-margin sales mix = more cash per cover.",deps:[],enables:[]},
  // W2: pricing after menu review
  { id:10,b:"B3",name:"Pricing Structure Review",dept:"ops",tier:"quick",hrs:8,w:[2,3],impact:"high",prio:"rev",desc:"Audit every price against cost, competition, willingness-to-pay. Uses food costing and menu review outputs.",pnl:"1â€“3% revenue increase. Direct EBITDA improvement.",bs:"Pure income statement play. Improves retained earnings.",cf:"Immediate cash flow improvement.",deps:[9,8],enables:[]},
  // W3: SOPs after stock take baseline
  { id:14,b:"B3",name:"Random Inspection SOP",dept:"finance",tier:"medium",hrs:6,w:[3,4],impact:"med",prio:"cost",desc:"Formalise unannounced branch inspections â€” cash, inventory, food safety.",pnl:"1â€“3% reduction in shrinkage and cash discrepancies.",bs:"Protects inventory asset value.",cf:"Prevents ongoing cash leakage at branch level.",deps:[13],enables:[23]},
  { id:22,b:"B3",name:"End-of-Month Inspection SOP",dept:"finance",tier:"medium",hrs:6,w:[3,4],impact:"med",prio:"cash",desc:"Standardise monthly close at branch level.",pnl:"Improves monthly P&L accuracy.",bs:"Ensures BS updated monthly, not annually.",cf:"Monthly cash reconciliation catches discrepancies early.",deps:[13],enables:[29]},
  { id:23,b:"B3",name:"Closing Procedures SOP",dept:"ops",tier:"medium",hrs:8,w:[4,6],impact:"med",prio:"cash",desc:"Standardise end-of-day: cash reconciliation, inventory logging, equipment, security.",pnl:"0.5â€“1% revenue protection from cash handling.",bs:"Protects daily cash asset.",cf:"EGP 500/day cash discrepancy = EGP 1.8M/year across branches.",deps:[13,14],enables:[29]},
  { id:27,b:"B3",name:"Discount Categories Audit & Policy",dept:"ops",tier:"medium",hrs:6,w:[5,6],impact:"med",prio:"rev",desc:"Review all discount types and authority. Requires branch P&L to quantify impact.",pnl:"1â€“3% revenue recovery from capped discounting.",bs:"Pure revenue protection.",cf:"Recovered revenue flows directly to cash.",deps:[2],enables:[]},
  { id:28,b:"B3",name:"Staff Meal Menu & Punching System",dept:"ops",tier:"medium",hrs:6,w:[4,5],impact:"low",prio:"cost",desc:"Dedicated staff menu and tracking system.",pnl:"0.5â€“1% food cost reduction.",bs:"Corrects inventory accuracy.",cf:"Reduces invisible daily cash drain.",deps:[21],enables:[]},
  { id:25,b:"B3",name:"Menu Items Guide (Prep Standards)",dept:"ops",tier:"moon",hrs:30,w:[5,11],impact:"med",prio:"cost",desc:"Full prep standards manual with photography of every plate.",pnl:"1â€“2% food cost reduction from portion control.",bs:"Improves inventory predictability.",cf:"Tighter portions = less cash consumed per dish.",deps:[8,12],enables:[]},

  // â”€â”€ B5: Reporting & Sustainability â”€â”€
  // W1: HR audit â€” parallel, no financial deps
  { id:11,b:"B5",name:"HR Structure, Policies & JD Review",dept:"hr",tier:"quick",hrs:14,w:[1,2],impact:"med",prio:"cost",desc:"Consolidate HR review: policies, job descriptions, org chart.",pnl:"5â€“10% labour reallocation opportunity.",bs:"Enables restructuring that reduces liability provisions.",cf:"Identifies overstaffing cash drain.",deps:[],enables:[30,37]},
  { id:37,b:"B5",name:"Redundant Headcount Reduction",dept:"hr",tier:"quick",hrs:10,w:[2,4],impact:"high",prio:"cost",desc:"Identify and action redundant, duplicated, or unproductive roles.",pnl:"5â€“12% labour cost reduction on targeted roles.",bs:"Reduces accrued payroll liabilities.",cf:"Permanent monthly cash saving â€” immediate impact.",deps:[11],enables:[30]},
  { id:30,b:"B5",name:"Salaries, Scale & Evaluations Review",dept:"hr",tier:"medium",hrs:14,w:[3,5],impact:"high",prio:"cost",desc:"Benchmark compensation vs. market.",pnl:"3â€“8% labour cost optimisation.",bs:"May reveal unrecorded payroll liabilities.",cf:"Right-sizing payroll = immediate monthly cash savings.",deps:[11,37],enables:[31,32]},
  // W6+: deep HR docs after review complete
  { id:31,b:"B5",name:"Policies & Procedures Manual",dept:"hr",tier:"moon",hrs:40,w:[6,11],impact:"high",prio:"cost",desc:"The operating bible â€” standardises every process across all departments.",pnl:"5â€“12% OpEx reduction from process standardisation.",bs:"Reduces contingent liabilities from compliance gaps.",cf:"Eliminates emergency spending and unplanned costs.",deps:[30],enables:[32]},
  { id:32,b:"B5",name:"Job Descriptions (All Roles)",dept:"hr",tier:"moon",hrs:30,w:[6,11],impact:"high",prio:"cost",desc:"Role-specific JDs with KPIs and accountability.",pnl:"3â€“6% labour cost reduction.",bs:"Supports restructuring provisions.",cf:"Permanently lower monthly payroll outflow.",deps:[30],enables:[]},
  // W8+: reporting cadence after branch P&Ls and SOPs exist
  { id:29,b:"B5",name:"Daily/Weekly/Monthly Financial Reports",dept:"finance",tier:"moon",hrs:20,w:[8,11],impact:"high",prio:"cash",desc:"Complete financial reporting cadence. Daily flash catches revenue drops on Day 1.",pnl:"5â€“10% faster response to P&L deviations.",bs:"Monthly BS reporting ensures continuous accuracy.",cf:"Daily cash reporting. Weekly forecast accuracy: Â±30% â†’ Â±5%.",deps:[1,2,22],enables:[]},
  { id:33,b:"B5",name:"Daily/Weekly/Monthly Ops Reports",dept:"ops",tier:"moon",hrs:16,w:[8,11],impact:"high",prio:"rev",desc:"Operational reporting: covers, average check, complaints, wait times, waste.",pnl:"3â€“8% improvement across operational P&L lines.",bs:"Validates inventory and asset utilisation.",cf:"Efficiency gains reduce daily cash burn.",deps:[2,23,24],enables:[]},

  // â”€â”€ B6: Deal Negotiations (parallel track) â”€â”€
  { id:38,b:"B6",name:"Quick Commerce Renegotiation & New Deals",dept:"deals",tier:"quick",hrs:24,w:[1,4],impact:"high",prio:"rev",desc:"Renegotiate existing quick commerce agreements (Talabat, Noon, etc.).",pnl:"1â€“3pp commission reduction = EGP 1.2Mâ€“3.6M/year.",bs:"Reduces accrued platform liabilities.",cf:"Shorter settlement cycles inject cash faster.",deps:[],enables:[35]},
  { id:34,b:"B6",name:"Deal / Contract Analysis & Assessment",dept:"deals",tier:"medium",hrs:40,w:[1,4],impact:"high",prio:"cash",desc:"Deep analysis: financial terms, obligations, risk allocation, benchmarking.",pnl:"Prevents unfavourable terms costing 5â€“15% of deal value.",bs:"Assesses BS impact: lease obligations, guarantees, earnouts.",cf:"Models full cash flow implications: upfront, ongoing, exit costs.",deps:[],enables:[35]},
  { id:35,b:"B6",name:"Deal Negotiation & Counter-Proposal",dept:"deals",tier:"medium",hrs:40,w:[5,8],impact:"high",prio:"cash",desc:"Negotiation strategy, counter-proposals, protect financial interests.",pnl:"Improved terms protect long-term P&L.",bs:"Negotiated terms affect long-term liabilities.",cf:"Better payment terms improve cash.",deps:[34],enables:[]},

  // â”€â”€ B7: Marketing & Sales Funnels â”€â”€
  // W2: baseline audit after first data available
  { id:39,b:"B7",name:"Marketing Audit & Baseline",dept:"ops",tier:"quick",hrs:10,w:[1,2],impact:"med",prio:"rev",desc:"Audit all existing digital channels: social media, GMB, Talabat/Noon listings, reviews. Establish baseline metrics before spending a pound.",pnl:"Uncovers wasted spend. Identifies zero-cost wins (GMB optimisation alone can drive 10â€“20% more foot traffic).",bs:"N/A â€” pure P&L play.",cf:"Stops bleeding on underperforming channels immediately.",deps:[],enables:[40,41]},
  { id:40,b:"B7",name:"Brand Standardisation Across Branches",dept:"ops",tier:"quick",hrs:8,w:[2,3],impact:"med",prio:"rev",desc:"Standardise logo usage, photography style, social bio, and menu images across all 8 branches. Inconsistency erodes trust and conversions.",pnl:"Lifts conversion rate 5â€“10% by removing friction.",bs:"N/A.",cf:"Higher conversion per impression = lower effective CAC.",deps:[39],enables:[42]},
  { id:41,b:"B7",name:"Google My Business Optimisation",dept:"ops",tier:"quick",hrs:6,w:[2,3],impact:"high",prio:"rev",desc:"Claim, verify, and fully optimise all 8 GMB listings: menus, photos, hours, Q&A, posts. Zero ad spend â€” highest ROI marketing activity.",pnl:"10â€“25% more walk-in traffic from local search.",bs:"N/A.",cf:"Drives direct covers with zero media cost.",deps:[39],enables:[]},
  { id:42,b:"B7",name:"Paid Channel Test â€” Social & Search",dept:"ops",tier:"medium",hrs:12,w:[3,6],impact:"med",prio:"rev",desc:"Run controlled 2-week paid test: Instagram/TikTok ads + Google Search ads. Budget EGP 5â€“10K per branch. Measure cost per order and cost per cover before scaling.",pnl:"Tests which channels deliver positive ROI before committing budget.",bs:"N/A.",cf:"Identifies where to scale spend for maximum revenue return.",deps:[40],enables:[44]},
  { id:43,b:"B7",name:"CRM & WhatsApp Loyalty Setup",dept:"ops",tier:"medium",hrs:10,w:[3,5],impact:"med",prio:"rev",desc:"Build customer database from POS + reservation data. Launch WhatsApp broadcast for existing customers â€” weekly offers, birthday deals, loyalty rewards.",pnl:"Repeat customer revenue is 5â€“7x cheaper to generate than new acquisition.",bs:"N/A.",cf:"Higher repeat rate = steadier weekly cash inflow.",deps:[39],enables:[44]},
  { id:44,b:"B7",name:"Sales Funnel Reporting & Optimisation",dept:"ops",tier:"medium",hrs:8,w:[6,9],impact:"high",prio:"rev",desc:"Build monthly funnel dashboard: impressions â†’ visits â†’ orders â†’ repeat rate. Review ROAS by channel. Reallocate budget from losers to winners every 4 weeks.",pnl:"15â€“30% marketing ROI improvement from disciplined optimisation.",bs:"N/A.",cf:"Reduces wasted ad spend â€” every EGP saved in CAC flows to EBITDA.",deps:[42,43],enables:[]},

  // â”€â”€ B8: Sales Incentive Scheme â”€â”€
  // W2: HR data needed first
  { id:45,b:"B8",name:"Salary & Role Benchmarking",dept:"hr",tier:"quick",hrs:8,w:[2,3],impact:"med",prio:"cost",desc:"Map every customer-facing role against market salary data. You cannot design a fair incentive scheme without knowing what the base looks like.",pnl:"Ensures incentives are additive, not substitutive â€” prevents gaming via base cuts.",bs:"N/A.",cf:"Sets the cash cost floor of the incentive programme.",deps:[11],enables:[46]},
  { id:46,b:"B8",name:"Commission Structure Design",dept:"hr",tier:"medium",hrs:12,w:[3,5],impact:"high",prio:"rev",desc:"Design commission tiers: base salary + % of revenue above target. Build in accelerators at 110% and 125% of target. Cap total payout to protect EBITDA.",pnl:"Well-designed commissions drive 5â€“15% revenue uplift from front-of-house.",bs:"N/A.",cf:"Commission cost self-funds from incremental revenue generated.",deps:[45,2],enables:[47,48]},
  { id:47,b:"B8",name:"KPI Bonus Framework",dept:"hr",tier:"medium",hrs:10,w:[5,7],impact:"high",prio:"rev",desc:"Define 6â€“8 KPI bonuses: avg check uplift, food cost control, review scores, upsell rate, shrinkage, repeat customer rate. Each must be measurable from existing systems.",pnl:"KPI bonuses drive margin-safe behaviour â€” not just top-line chasing.",bs:"N/A.",cf:"Bonus pool funded from the EBITDA improvement it generates.",deps:[46,1],enables:[49]},
  { id:48,b:"B8",name:"Branch Leaderboard & Competition System",dept:"ops",tier:"medium",hrs:6,w:[5,7],impact:"med",prio:"rev",desc:"Monthly branch ranking: 5 weighted metrics (revenue vs target, EBITDA margin, avg check, review score, food cost%). Winner gets team bonus + recognition. Creates healthy competition.",pnl:"Leaderboard drives 3â€“8% improvement in bottom-quartile branches.",bs:"N/A.",cf:"Branch competition self-funds from performance uplift.",deps:[46],enables:[49]},
  { id:49,b:"B8",name:"Incentive Scheme Launch & Training",dept:"hr",tier:"medium",hrs:12,w:[7,9],impact:"high",prio:"rev",desc:"Roll out to all branches: explain the scheme, set Month 1 targets, distribute scorecards. Train managers on how to track and motivate. Without launch, even perfect scheme design fails.",pnl:"Activation is where the P&L impact starts. Paper schemes deliver zero.",bs:"N/A.",cf:"Month 1 bonuses paid from Month 2 verified performance.",deps:[47,48],enables:[]},
];

const milestoneFees = [
  { id:"S1",milestone:"EBITDA reaches breakeven (0%)",current:"Negative EBITDA",target:"0% EBITDA margin",saving:"EGP 2.4Mâ€“6M (depending on current deficit)",fee:300000,feeLabel:"EGP 300K",color:"#16653a",icon:"ðŸŽ¯",how:"Monthly P&L shows EBITDA â‰¥ 0 for 2 consecutive months, verified jointly." },
  { id:"S2",milestone:"EBITDA reaches 5% of revenue",current:"0% EBITDA",target:"5% = EGP 6M/year",saving:"EGP 6M annual profit created",fee:500000,feeLabel:"EGP 500K",color:"#1e40af",icon:"ðŸ“ˆ",how:"Trailing 3-month average EBITDA â‰¥ 5% of revenue, verified from audited P&L." },
  { id:"S3",milestone:"EBITDA reaches 10% of revenue",current:"5% EBITDA",target:"10% = EGP 12M/year",saving:"EGP 6M additional annual profit",fee:750000,feeLabel:"EGP 750K",color:"#7c3aed",icon:"ðŸš€",how:"Trailing 3-month average EBITDA â‰¥ 10%. This is the well-run F&B benchmark." },
  { id:"S4",milestone:"Food cost reduced by â‰¥ 2pp",current:"Est. 36â€“40%",target:"34â€“38% or lower",saving:"Each point = EGP 1.2M/year on EGP 120M",fee:200000,feeLabel:"EGP 200K/point",color:"#a16207",icon:"ðŸ½",how:"Trailing 3-month average food cost % vs. Month 1 baseline." },
  { id:"S5",milestone:"Revenue recovery (off-book captured)",current:"Unknown leakage",target:"Captured & recorded",saving:"Typically 2â€“5% of revenue = EGP 2.4Mâ€“6M",fee:0,feeLabel:"3% of recovered",color:"#dc2626",icon:"ðŸ’°",how:"Total verified unrecorded revenue identified through reconciliation." },
  { id:"S6",milestone:"Shrinkage reduced below 1.5%",current:"Est. 3â€“5%",target:"â‰¤ 1.5% of purchases",saving:"1.5% on ~EGP 45M = EGP 675K",fee:0,feeLabel:"5% of savings",color:"#be185d",icon:"ðŸ“¦",how:"Pre-engagement shrinkage (first stock take) vs. Month 6 stock take." },
];

const marketComp = [
  { provider:"Big 4 Advisory (Deloitte / EY)",monthly:"EGP 450Kâ€“750K",total:"EGP 2.7Mâ€“4.5M",success:"None",verdict:"Overkill for single-brand F&B. Generic frameworks. You pay for the brand.",score:2 },
  { provider:"Regional F&B Consultancy",monthly:"EGP 150Kâ€“300K",total:"EGP 450Kâ€“900K",success:"Rare (5â€“10%)",verdict:"Strong on concept/menu but weak on financial controls and system gap analysis.",score:3 },
  { provider:"Freelance F&B Consultant (Egypt)",monthly:"EGP 120Kâ€“200K",total:"EGP 240Kâ€“600K",success:"None",verdict:"Expensive per output. No financial depth â€” no P&L, no bank reconciliation, no gap analysis.",score:2 },
  { provider:"Fractional CFO (International)",monthly:"EGP 140Kâ€“470K",total:"EGP 1.7Mâ€“5.6M/yr",success:"Rare (0â€“5%)",verdict:"Strong finance but zero F&B ops. Won't audit recipes or run stock takes.",score:2 },
  { provider:"CÂ² Fractional Management",monthly:"EGP 192K (M1) â†’ 100K+",total:"EGP 700Kâ€“750K",success:"EBITDA milestones",verdict:"Full-scope: finance + ops + HR + deals. M1 includes 80h firefighting + 80h structured deliverables. Success fees only on verified P&L improvement.",score:5 },
];

const requirements = [
  { item:"Full access to accounting system & chart of accounts",who:"CFO / Finance team",due:"Day 1",critical:true },
  { item:"Bank statements â€” all accounts, last 24 months",who:"CFO / Finance team",due:"Day 1",critical:true },
  { item:"All supplier contracts & outstanding invoices",who:"Procurement lead",due:"Day 1",critical:true },
  { item:"POS sales data export â€” all branches, last 12 months",who:"IT / Branch managers",due:"Day 1",critical:true },
  { item:"Payroll records & org chart (all entities)",who:"HR lead",due:"Day 1",critical:true },
  { item:"All existing deal contracts (QC platforms, partners, leases)",who:"Legal / Management",due:"Day 1",critical:true },
  { item:"Branch manager availability for stock take (2â€“3 hrs each)",who:"Branch managers",due:"Week 1â€“2",critical:true },
  { item:"Food costing system access or raw recipe data",who:"Kitchen / Ops lead",due:"Week 1",critical:true },
  { item:"Fixed asset register (or best available list)",who:"Finance team",due:"Week 1",critical:false },
  { item:"2025 budget file (Excel or system export)",who:"CFO",due:"Week 1",critical:false },
  { item:"All inter-branch settlement records & cash transfer logs",who:"Finance team",due:"Week 1",critical:false },
  { item:"HR files: contracts, job grades, evaluation history",who:"HR lead",due:"Week 2",critical:false },
  { item:"Marketing spend breakdown & campaign history",who:"Marketing / Management",due:"Week 2",critical:false },
  { item:"Dedicated internal point-of-contact (min. 10 hrs/week availability)",who:"Management",due:"Ongoing",critical:true },
];

// Buckets without B4
const buckets = [
  { id:"B1",name:"Financial Visibility & Controls",color:"#1e40af",bg:"#eff6ff",bdr:"#bfdbfe",ico:"ðŸ“Š",tier:"quick",weeks:"1â€“8",primaryPrio:"cost",impactPills:[{p:"cash",v:"EGP 1.2M+",l:"Accrued collections"},{p:"cost",v:"EGP 3â€“8M",l:"Food & asset cost fix"},{p:"rev",v:"2â€“5%",l:"Unrecorded revenue"}],desc:"Foundation layer. Bank reconciliation, transaction registration, food costing, and assets start W1. P&L per Branch comes first (W4â€“6) â€” branches must be clean before consolidating. Consolidated P&L follows (W6â€“8). Financial Position Statement last." },
  { id:"B2",name:"Cost & Revenue Deep-Dive",color:"#a16207",bg:"#fffbeb",bdr:"#fde68a",ico:"ðŸ”",tier:"medium",weeks:"2â€“9",primaryPrio:"cost",impactPills:[{p:"cost",v:"EGP 450Kâ€“1.35M",l:"Shrinkage control"},{p:"cost",v:"5â€“12%",l:"Branch expense cuts"},{p:"rev",v:"3â€“8%",l:"Revenue uplift"}],desc:"Stock take and menu costing start W2 once transactions are registered. Purchases analysis W3â€“5. Revenue and expense deep-dives wait until branch P&Ls are stable (W7â€“9)." },
  { id:"B3",name:"Operational SOPs & Controls",color:"#16653a",bg:"#f0fdf4",bdr:"#bbf7d0",ico:"âš™ï¸",tier:"medium",weeks:"1â€“11",primaryPrio:"rev",impactPills:[{p:"rev",v:"EGP 1.2â€“6M",l:"Pricing & menu uplift"},{p:"rev",v:"1â€“3%",l:"Discount recovery"},{p:"cash",v:"EGP 1.8M/yr",l:"Daily cash leakage stopped"}],desc:"Menu review, sales mix, and pricing are immediate W1â€“3 quick wins. SOPs (inspections, closing procedures) follow the stock take baseline in W3â€“6. Discount policy waits for branch P&L data." },
  { id:"B5",name:"Reporting & Sustainability",color:"#7c3aed",bg:"#faf5ff",bdr:"#ddd6fe",ico:"ðŸ“ˆ",tier:"moon",weeks:"1â€“11",primaryPrio:"cost",impactPills:[{p:"cost",v:"EGP 120K+/yr",l:"Per redundant headcount removed"},{p:"cost",v:"3â€“8%",l:"Labour optimisation"},{p:"rev",v:"3â€“8%",l:"Ops P&L improvement"}],desc:"HR audit and headcount reduction are parallel W1 starts. Salary benchmarking W3â€“5. P&P manual and JDs W6â€“11. Financial and ops reporting cadences start W8 once underlying data is reliable." },
  { id:"B6",name:"Deal Negotiations",color:"#0f766e",bg:"#f0fdfa",bdr:"#99f6e4",ico:"ðŸ¤",tier:"medium",weeks:"1â€“8",primaryPrio:"rev",impactPills:[{p:"rev",v:"EGP 1.2â€“3.6M/yr",l:"QC commission savings"},{p:"cash",v:"Faster",l:"Settlement cycles"},{p:"cash",v:"5â€“15%",l:"Deal value protected"}],desc:"Fully parallel track. QC renegotiation and contract analysis start W1. Counter-proposals and term sheets in Month 2 (W5â€“8)." },
  { id:"B7",name:"Marketing & Sales Funnels",color:"#be185d",bg:"#fdf2f8",bdr:"#f9a8d4",ico:"ðŸ“¢",tier:"medium",weeks:"1â€“9",primaryPrio:"rev",impactPills:[{p:"rev",v:"10â€“25%",l:"More walk-ins from GMB"},{p:"rev",v:"5â€“7x",l:"Cheaper repeat vs new"},{p:"rev",v:"15â€“30%",l:"Marketing ROI uplift"}],desc:"Audit and GMB optimisation are zero-cost W1 wins. Brand standardisation W2â€“3. Paid channel testing W3â€“6 with controlled budgets. CRM/WhatsApp loyalty W3â€“5. Funnel reporting and optimisation W6â€“9." },
  { id:"B8",name:"Sales Incentive Scheme",color:"#d97706",bg:"#fffbeb",bdr:"#fcd34d",ico:"ðŸ†",tier:"medium",weeks:"2â€“9",primaryPrio:"rev",impactPills:[{p:"rev",v:"5â€“15%",l:"Front-of-house uplift"},{p:"cost",v:"3â€“8%",l:"Labour cost optimisation"},{p:"rev",v:"3â€“8%",l:"Bottom-quartile branch lift"}],desc:"Starts after HR audit (W1) provides salary baseline. Commission structure W3â€“5. KPI bonuses and leaderboard W5â€“7 (requires P&L data). Full scheme launch and training W7â€“9." },
];

const WEEKS=[1,2,3,4,5,6,7,8,9,10,11,12];
const mono="'DM Mono',monospace",sans="'DM Sans','Segoe UI',sans-serif",disp="'Outfit',sans-serif";

function computeMonthly(taskList) {
  const months=[{w:[1,4],label:"Month 1",wks:"W1â€“W4"},{w:[5,8],label:"Month 2",wks:"W5â€“W8"},{w:[9,12],label:"Month 3",wks:"W9â€“W12"}];
  return months.map((m,mi)=>{
    const hrs=taskList.reduce((sum,t)=>{
      const span=t.w[1]-t.w[0]+1; let ov=0;
      for(let w=m.w[0];w<=m.w[1];w++) if(w>=t.w[0]&&w<=t.w[1]) ov++;
      return sum+(t.hrs*ov/span);
    },0);
    const roundH=Math.round(hrs);
    const deliverableHrs = mi===0 ? Math.min(roundH, M1_CAP - M1_FIREFIGHT) : roundH;
    const firefightHrs = mi===0 ? M1_FIREFIGHT : 0;
    const totalHrs = mi===0 ? M1_CAP : roundH;
    const computed=totalHrs*RATE;
    const floor=mi===2?150000:MIN_RETAINER;
    const retainer=Math.max(computed,floor);
    const tks=taskList.filter(t=>{for(let w=m.w[0];w<=m.w[1];w++) if(w>=t.w[0]&&w<=t.w[1]) return true; return false;});
    return {...m,hrs:totalHrs,deliverableHrs,firefightHrs,computed,retainer,tasks:tks,isFloor:computed<floor};
  });
}

function prioSort(a,b){
  if(PRIO_ORDER[a.prio]!==PRIO_ORDER[b.prio]) return PRIO_ORDER[a.prio]-PRIO_ORDER[b.prio];
  const impOrd={high:0,med:1,low:2},tierOrd={quick:0,medium:1,moon:2};
  if(impOrd[a.impact]!==impOrd[b.impact]) return impOrd[a.impact]-impOrd[b.impact];
  return tierOrd[a.tier]-tierOrd[b.tier];
}

// â•â•â• EXCEL EXPORT â•â•â•
function exportToExcel(tasks, opsMonthly, dealMonthly, budgetData, comments) {
  const wb = XLSX.utils.book_new();

  // Sheet 1: Tasks
  const taskRows = [["#","Bucket","Task Name","Department","Tier","Hours","Week Start","Week End","Impact","Priority","Description","P&L Impact","Balance Sheet","Cash Flow"]];
  tasks.forEach(t => {
    taskRows.push([t.id,t.b,t.name,D[t.dept]?.l||t.dept,T[t.tier]?.l||t.tier,t.hrs,t.w[0],t.w[1],IMP[t.impact]?.l||t.impact,PRIO[t.prio]?.l||t.prio,t.desc,t.pnl,t.bs,t.cf]);
  });
  const ws1 = XLSX.utils.aoa_to_sheet(taskRows);
  ws1['!cols'] = [{wch:5},{wch:6},{wch:35},{wch:20},{wch:12},{wch:8},{wch:10},{wch:10},{wch:8},{wch:15},{wch:50},{wch:40},{wch:40},{wch:40}];
  XLSX.utils.book_append_sheet(wb, ws1, "Tasks");

  // Sheet 2: Monthly Pricing
  const priceRows = [["Month","Weeks","Active Tasks","Total Hours","Rate (EGP)","Computed (EGP)","Retainer (EGP)","Notes"]];
  [...opsMonthly, ...dealMonthly.filter(m=>m.hrs>0)].forEach((m,i) => {
    priceRows.push([m.label+(i>=3?" (Deals)":""),m.wks,m.tasks.length,m.hrs,RATE,m.computed,m.retainer,m.isFloor?"Minimum retainer applies":""]);
  });
  const ws2 = XLSX.utils.aoa_to_sheet(priceRows);
  ws2['!cols'] = [{wch:15},{wch:10},{wch:14},{wch:14},{wch:14},{wch:18},{wch:18},{wch:30}];
  XLSX.utils.book_append_sheet(wb, ws2, "Monthly Pricing");

  // Sheet 3: Budget vs Actual
  const budRows = [["Branch","Month","Revenue Forecast","Revenue Actual","Revenue Variance","Food Cost Forecast","Food Cost Actual","Food Cost Variance","Labour Forecast","Labour Actual","Labour Variance","EBITDA Forecast","EBITDA Actual","EBITDA Variance"]];
  if(budgetData && budgetData.length>0) {
    budgetData.forEach(row => {
      budRows.push([row.branch,row.month,row.revF,row.revA,row.revA-row.revF,row.fcF,row.fcA,row.fcA-row.fcF,row.labF,row.labA,row.labA-row.labF,row.ebitdaF,row.ebitdaA,row.ebitdaA-row.ebitdaF]);
    });
  }
  const ws3 = XLSX.utils.aoa_to_sheet(budRows);
  ws3['!cols'] = Array(14).fill({wch:20});
  XLSX.utils.book_append_sheet(wb, ws3, "Budget vs Actual");

  // Sheet 4: Comments & Tasks
  const commRows = [["Date","Author","Type","Content","Related Task","Status"]];
  (comments||[]).forEach(c => {
    commRows.push([c.date,c.author,c.type,c.content,c.task||"",c.status||"Open"]);
  });
  const ws4 = XLSX.utils.aoa_to_sheet(commRows);
  ws4['!cols'] = [{wch:20},{wch:20},{wch:15},{wch:60},{wch:30},{wch:12}];
  XLSX.utils.book_append_sheet(wb, ws4, "Comments & Notes");

  XLSX.writeFile(wb, "C2_Abou_Shakra_Dashboard.xlsx");
}

// â•â•â• BUDGET INITIAL DATA â•â•â•
function mkBudgetRow(branch, month) {
  return { id:`${branch}-${month}`, branch, month, revF:"", revA:"", fcF:"", fcA:"", labF:"", labA:"", ebitdaF:"", ebitdaA:"" };
}

function AgentWidget({mktPlan,tasks,view,updMktCh,updMktB2B,updMktPricing,setTasks,setView}){
  const {useState,useEffect,useRef}=React;
  const [agentOpen,setAgentOpen]=useState(false);
  const [agentMsgs,setAgentMsgs]=useState([{role:"assistant",content:"Hi! I'm your CÂ² dashboard assistant. Ask me anything about the dashboard or say things like \"set Instagram budget to 20000\", \"update Iftar avg check to 380\", or \"go to Ramadan plan\"."}]);
  const [agentInput,setAgentInput]=useState("");
  const [agentLoading,setAgentLoading]=useState(false);
  const [agentError,setAgentError]=useState("");
  const msgEndRef=useRef(null);
  const sans="DM Sans,sans-serif", mono="DM Mono,monospace", disp="DM Sans,sans-serif";

  useEffect(()=>{if(agentOpen&&msgEndRef.current)msgEndRef.current.scrollIntoView({behavior:"smooth"});},[agentMsgs,agentOpen]);

  const SYSTEM=`You are an embedded assistant inside the CÂ² Fractional Management dashboard for Abou Shakra, an Egyptian F&B group (8 branches, EGP 120M/year, currently EBITDA negative). You have full access to dashboard state and can edit any value via tools.

DASHBOARD TABS: overview, buckets (B1â€“B5 engagement work), timeline (tasks with weeks/hours), pricing (monthly retainer tiers), success (KPIs), market (analysis), notes (comments/actions), budget (branch P&L), mktplan (Ramadan marketing).

RAMADAN PLAN STATE:
- B2C channels: social (Instagram/TikTok), google (Ads), influencer, talabat (delivery), crm (WhatsApp), gmb (Google My Business)
- Each channel has: budget (EGP), impressions, clicks, orders, active (bool)
- B2B: pipelineClients, closeRate (%), avgGroupSize (covers), avgPackagePrice (EGP/person), bookingsPerClient, salesBudget
- Pricing: avgCheckIftar (EGP340), avgCheckSuhoor (EGP280), avgCheckDelivery (EGP185), iftarCoversPerNight (320), suhoorCoversPerNight (140), deliveryOrdersPerMonth (680), ramadanNights (30), repeatRate (45%)

Be concise. Use numbers. Answer in context of F&B Egypt turnaround consulting.`;

  const TOOLS=[
    {name:"update_mkt_channel",description:"Update a B2C marketing channel. Channels: social,google,influencer,talabat,crm,gmb. Fields: budget(number),impressions(string),clicks(string),orders(string),active(boolean),name(string).",input_schema:{type:"object",properties:{channel:{type:"string",enum:["social","google","influencer","talabat","crm","gmb"]},field:{type:"string"},value:{type:["string","number","boolean"]}},required:["channel","field","value"]}},
    {name:"update_b2b",description:"Update B2B pipeline. Fields: pipelineClients,closeRate,avgGroupSize,avgPackagePrice,bookingsPerClient,salesBudget(numbers), active(boolean), notes(string).",input_schema:{type:"object",properties:{field:{type:"string"},value:{type:["string","number","boolean"]}},required:["field","value"]}},
    {name:"update_pricing",description:"Update pricing/session input. Fields: avgCheckIftar,avgCheckSuhoor,avgCheckDelivery,iftarCoversPerNight,suhoorCoversPerNight,deliveryOrdersPerMonth,ramadanNights,repeatRate (all numbers).",input_schema:{type:"object",properties:{field:{type:"string"},value:{type:"number"}},required:["field","value"]}},
    {name:"update_task",description:"Update a task by id. Fields: name(string),status(string: todo/inprogress/done),hrs(number),dept(string),prio(string: rev/cost/cash),impact(string: high/med/low).",input_schema:{type:"object",properties:{taskId:{type:"number"},field:{type:"string"},value:{type:["string","number"]}},required:["taskId","field","value"]}},
    {name:"navigate_to",description:"Switch dashboard to a tab.",input_schema:{type:"object",properties:{view:{type:"string",enum:["overview","buckets","timeline","pricing","success","market","notes","budget","mktplan"]}},required:["view"]}},
    {name:"read_state",description:"Read dashboard state to answer questions. section: mktplan, tasks, pricing, b2b, or overview.",input_schema:{type:"object",properties:{section:{type:"string"}},required:["section"]}}
  ];

  const executeTool=(name,input)=>{
    if(name==="update_mkt_channel"){updMktCh(input.channel,input.field,input.value);return`Updated ${input.channel}.${input.field} â†’ ${input.value}`;}
    if(name==="update_b2b"){updMktB2B(input.field,input.value);return`Updated B2B.${input.field} â†’ ${input.value}`;}
    if(name==="update_pricing"){updMktPricing(input.field,input.value);return`Updated pricing.${input.field} â†’ ${input.value}`;}
    if(name==="update_task"){setTasks(p=>p.map(t=>t.id===input.taskId?{...t,[input.field]:input.value}:t));return`Updated task #${input.taskId} ${input.field} â†’ ${input.value}`;}
    if(name==="navigate_to"){setView(input.view);return`Navigated to ${input.view}`;}
    if(name==="read_state"){
      const s=input.section;
      if(s==="mktplan")return JSON.stringify({channels:mktPlan.channels,b2b:mktPlan.b2b,pricing:mktPlan.pricing},null,2);
      if(s==="tasks")return JSON.stringify(tasks.slice(0,25).map(t=>({id:t.id,name:t.name,b:t.b,hrs:t.hrs,status:t.status||"todo",prio:t.prio})),null,2);
      if(s==="pricing")return JSON.stringify(mktPlan.pricing,null,2);
      if(s==="b2b")return JSON.stringify(mktPlan.b2b,null,2);
      if(s==="overview")return JSON.stringify({totalTasks:tasks.length,view,branches:8,annualRevEGP:"120M",ebitda:"negative"});
      return JSON.stringify({view,taskCount:tasks.length});
    }
    return "Tool not found: "+name;
  };

  const sendMessage=async()=>{
    const text=agentInput.trim();
    if(!text||agentLoading)return;
    setAgentInput("");setAgentError("");
    const newMsgs=[...agentMsgs,{role:"user",content:text}];
    setAgentMsgs(newMsgs);
    setAgentLoading(true);
    let apiMsgs=newMsgs.map(m=>({role:m.role,content:m.content}));
    try{
      let iters=6;
      while(iters-->0){
        const res=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,system:SYSTEM,tools:TOOLS,messages:apiMsgs})});
        const data=await res.json();
        if(!res.ok){setAgentError(data.error?.message||"API error "+res.status);break;}
        const toolUses=data.content.filter(b=>b.type==="tool_use");
        const textBlocks=data.content.filter(b=>b.type==="text");
        if(toolUses.length===0){
          setAgentMsgs(p=>[...p,{role:"assistant",content:textBlocks.map(b=>b.text).join("\n").trim()}]);
          break;
        }
        const toolResults=toolUses.map(tu=>({type:"tool_result",tool_use_id:tu.id,content:executeTool(tu.name,tu.input)}));
        if(textBlocks.length>0){const t=textBlocks.map(b=>b.text).join(" ").trim();if(t)setAgentMsgs(p=>[...p,{role:"assistant",content:t,dim:true}]);}
        apiMsgs=[...apiMsgs,{role:"assistant",content:data.content},{role:"user",content:toolResults}];
      }
    }catch(e){setAgentError("Network error: "+e.message);}
    setAgentLoading(false);
  };

  const pill={fontFamily:mono,fontSize:8.5,padding:"3px 7px",borderRadius:4,cursor:"pointer",border:"1px solid #e5e1dc",background:"#fff",color:"#666",whiteSpace:"nowrap",boxShadow:"0 1px 3px rgba(0,0,0,0.06)"};
  const SUGGESTIONS=["What's the blended CAC?","Best channel ROAS?","Set Instagram budget to 20000","Update Iftar avg check to 380","B2B revenue estimate","Go to Ramadan plan"];

  return(
    <div style={{position:"fixed",bottom:20,right:20,zIndex:9999,display:"flex",flexDirection:"column",alignItems:"flex-end",gap:6}}>
      {/* Suggestion pills â€” only when closed */}
      {!agentOpen&&<div style={{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:4}}>
        {SUGGESTIONS.map((s,i)=><button key={i} style={pill} onClick={()=>{setAgentOpen(true);setTimeout(()=>setAgentInput(s),50);}}>{s}</button>)}
      </div>}

      {/* Chat window */}
      {agentOpen&&<div style={{width:360,background:"#fff",border:"1px solid #e5e1dc",borderRadius:12,boxShadow:"0 8px 32px rgba(0,0,0,0.14)",display:"flex",flexDirection:"column",maxHeight:520}}>
        {/* Header */}
        <div style={{background:"linear-gradient(135deg,#0f172a,#1e293b)",padding:"12px 14px",display:"flex",justifyContent:"space-between",alignItems:"center",borderRadius:"12px 12px 0 0",flexShrink:0}}>
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <div style={{width:30,height:30,borderRadius:"50%",background:"linear-gradient(135deg,#3b82f6,#8b5cf6)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:15,flexShrink:0}}>âœ¦</div>
            <div>
              <div style={{fontFamily:sans,fontSize:12,fontWeight:700,color:"#fff"}}>CÂ² Dashboard Assistant</div>
              <div style={{fontFamily:mono,fontSize:7.5,color:"rgba(255,255,255,0.35)",letterSpacing:1}}>READS & EDITS LIVE Â· ABOU SHAKRA</div>
            </div>
          </div>
          <button onClick={()=>setAgentOpen(false)} style={{background:"none",border:"none",color:"rgba(255,255,255,0.4)",fontSize:18,cursor:"pointer",lineHeight:1,padding:"0 2px"}}>âœ•</button>
        </div>

        {/* Messages */}
        <div style={{flex:1,overflowY:"auto",padding:"12px",display:"flex",flexDirection:"column",gap:8,minHeight:0}}>
          {agentMsgs.map((m,i)=>(
            <div key={i} style={{display:"flex",justifyContent:m.role==="user"?"flex-end":"flex-start"}}>
              <div style={{maxWidth:"87%",padding:"9px 12px",borderRadius:m.role==="user"?"10px 10px 2px 10px":"10px 10px 10px 2px",background:m.role==="user"?"#1e293b":m.dim?"#f9f8f6":"#f0f4ff",color:m.role==="user"?"#fff":m.dim?"#aaa":"#1a1a1a",fontFamily:sans,fontSize:11,lineHeight:1.65,whiteSpace:"pre-wrap"}}>
                {m.content}
              </div>
            </div>
          ))}
          {agentLoading&&<div style={{display:"flex",justifyContent:"flex-start"}}>
            <div style={{padding:"9px 16px",borderRadius:"10px 10px 10px 2px",background:"#f0f4ff",fontFamily:mono,fontSize:13,color:"#94a3b8",letterSpacing:3}}>Â·Â·Â·</div>
          </div>}
          {agentError&&<div style={{fontFamily:mono,fontSize:8.5,color:"#dc2626",background:"#fef2f2",border:"1px solid #fecaca",borderRadius:5,padding:"6px 10px",textAlign:"center"}}>{agentError}</div>}
          <div ref={msgEndRef}/>
        </div>

        {/* Quick action chips */}
        <div style={{padding:"5px 10px",borderTop:"1px solid #f0ede8",display:"flex",gap:4,flexWrap:"wrap",flexShrink:0}}>
          {["CAC breakdown","Best ROAS","B2B pipeline","Total budget","Timeline","Ramadan plan"].map((s,i)=>(
            <button key={i} style={{...pill,fontSize:7.5,padding:"2px 6px"}} onClick={()=>setAgentInput(s)}>{s}</button>
          ))}
        </div>

        {/* Input bar */}
        <div style={{padding:"8px 10px",borderTop:"1px solid #f0ede8",display:"flex",gap:6,flexShrink:0}}>
          <input value={agentInput} onChange={e=>setAgentInput(e.target.value)} onKeyDown={e=>e.key==="Enter"&&!e.shiftKey&&sendMessage()}
            placeholder="Ask or edit: 'set social budget to 20000'â€¦"
            style={{flex:1,padding:"8px 10px",border:"1px solid #e5e1dc",borderRadius:7,fontFamily:sans,fontSize:11,outline:"none",background:"#fafaf8"}}/>
          <button onClick={sendMessage} disabled={agentLoading||!agentInput.trim()}
            style={{padding:"8px 13px",background:agentLoading||!agentInput.trim()?"#e5e1dc":"#1e293b",color:agentLoading||!agentInput.trim()?"#bbb":"#fff",border:"none",borderRadius:7,fontFamily:mono,fontSize:11,fontWeight:700,cursor:agentLoading||!agentInput.trim()?"default":"pointer",transition:"background 0.15s"}}>
            {agentLoading?"Â·Â·Â·":"â†’"}
          </button>
        </div>
      </div>}

      {/* Toggle FAB */}
      <button onClick={()=>{setAgentOpen(o=>!o);setAgentError("");}}
        style={{width:46,height:46,borderRadius:"50%",background:agentOpen?"#f5f3f0":"linear-gradient(135deg,#1e293b,#3b82f6)",border:agentOpen?"1px solid #e5e1dc":"none",color:agentOpen?"#888":"#fff",fontSize:18,cursor:"pointer",boxShadow:"0 4px 16px rgba(0,0,0,0.18)",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s",alignSelf:"flex-end"}}>
        {agentOpen?"âœ•":"âœ¦"}
      </button>
    </div>
  );
}

const App = function App(){
  const [authed,setAuthed]=useState(false),[pw,setPw]=useState(""),[pwErr,setPwErr]=useState(false);
  const [view,setView]=useState("overview");
  const [expBucket,setExpBucket]=useState(null),[expTask,setExpTask]=useState(null),[expFee,setExpFee]=useState(null);
  const [tasks,setTasks]=useState(INITIAL_TASKS);
  const [comments,setComments]=useState([]);
  const [showAddTask,setShowAddTask]=useState(false);
  const [showAddComment,setShowAddComment]=useState(false);
  const [budgetData,setBudgetData]=useState([]);
  const [budgetBranch,setBudgetBranch]=useState(BRANCHES[0]);
  const [budgetMonth,setBudgetMonth]=useState(MONTHS_LIST[0]);
  const [editingBudget,setEditingBudget]=useState(null);

  // Incentive scheme inputs
  const [incentiveInputs,setIncentiveInputs]=useState({
    branchMgrBase:11000, floorSupBase:6500, waiterBase:4000, qcBase:5000, hostBase:4500, salesMgrBase:15000,
    avgMonthlyRevPerBranch:1250000, avgCheckTarget:250, coversPerMonth:5000,
    foodCostTarget:36, qcRevenueShare:18,
    commissionPct:2, accelerator110:2.5, accelerator125:3.5,
    avgCheckBonus:2000, foodCostBonus:3000, reviewBonus:1500, upsellBonus:100,
    leaderboardFirst:10000, leaderboardSecond:5000, leaderboardThird:2500,
  });
  const [taskFilter,setTaskFilter]=useState("all");
  const [commentFilter,setCommentFilter]=useState("all");

  // Marketing & Sales Plan state
  const [mktPlan,setMktPlan]=useState({
    channels:{
      social:    {name:"Instagram / TikTok â€” Ramadan", budget:14000,active:true, impressions:"180000",clicks:"7200",orders:"420"},
      google:    {name:"Google Ads â€” Iftar & Suhoor",  budget:10000,active:true, impressions:"95000", clicks:"5100",orders:"380"},
      influencer:{name:"Food Influencers â€” Ramadan",   budget:12000,active:true, impressions:"220000",clicks:"9800",orders:"310"},
      talabat:   {name:"Talabat / Noon â€” Iftar",       budget:8000, active:true, impressions:"75000", clicks:"4200",orders:"680"},
      crm:       {name:"WhatsApp CRM â€” Suhoor & Iftar",budget:3000, active:true, impressions:"12000", clicks:"4800",orders:"190"},
      gmb:       {name:"Google My Business â€” Organic", budget:0,    active:true, impressions:"38000", clicks:"3100",orders:"95"},
    },
    b2b:{
      active:true,
      pipelineClients:12, closeRate:40, avgGroupSize:25,
      avgPackagePrice:280, bookingsPerClient:2, salesBudget:8000, notes:"",
    },
    pricing:{
      avgCheckIftar:340, avgCheckSuhoor:280, avgCheckDelivery:185,
      iftarCoversPerNight:320, suhoorCoversPerNight:140, deliveryOrdersPerMonth:680,
      repeatRate:45, ramadanNights:30,
    },
    notes:"",
  });
  const updMktB2B=(f,v)=>setMktPlan(p=>({...p,b2b:{...p.b2b,[f]:v}}));
  const updMktPricing=(f,v)=>setMktPlan(p=>({...p,pricing:{...p.pricing,[f]:v}}));

  const updMktCh=(key,field,val)=>setMktPlan(p=>({...p,channels:{...p.channels,[key]:{...p.channels[key],[field]:val}}}));
  const updMktFunnel=(field,val)=>setMktPlan(p=>({...p,funnel:{...p.funnel,[field]:val}}));
  const updMktTarget=(field,val)=>setMktPlan(p=>({...p,targets:{...p.targets,[field]:val}}));

  // New task form
  const [newTask,setNewTask]=useState({name:"",dept:"finance",tier:"quick",hrs:4,w:[1,4],impact:"med",prio:"cost",b:"B1",desc:"",pnl:"",bs:"",cf:""});
  // New comment form
  const [newComment,setNewComment]=useState({author:"",type:"comment",content:"",task:"",status:"Open"});

  const opsTasks=useMemo(()=>tasks.filter(t=>t.b!=="B6"),[tasks]);
  const dealTasks=useMemo(()=>tasks.filter(t=>t.b==="B6"),[tasks]);
  const opsMonthly=useMemo(()=>computeMonthly(opsTasks),[opsTasks]);
  const dealMonthly=useMemo(()=>computeMonthly(dealTasks),[dealTasks]);
  const opsTotal=opsMonthly.reduce((s,m)=>s+m.retainer,0);
  const dealTotal=dealMonthly.filter(m=>m.hrs>0).reduce((s,m)=>s+m.retainer,0);
  const grandTotal=opsTotal+dealTotal;

  const handleLogin=()=>{if(pw===PW){setAuthed(true);setPwErr(false)}else setPwErr(true)};

  const addTask=()=>{
    const id=Math.max(...tasks.map(t=>t.id))+1;
    setTasks(prev=>[...prev,{...newTask,id,deps:[],enables:[]}]);
    setNewTask({name:"",dept:"finance",tier:"quick",hrs:4,w:[1,4],impact:"med",prio:"cost",b:"B1",desc:"",pnl:"",bs:"",cf:""});
    setShowAddTask(false);
  };

  const addComment=()=>{
    const c={...newComment,id:Date.now(),date:new Date().toLocaleString("en-GB",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})};
    setComments(prev=>[c,...prev]);
    setNewComment({author:"",type:"comment",content:"",task:"",status:"Open"});
    setShowAddComment(false);
  };

  const updateBudget=(id,field,val)=>{
    setBudgetData(prev=>prev.map(r=>r.id===id?{...r,[field]:val}:r));
  };

  const addBudgetRow=()=>{
    const key=`${budgetBranch}-${budgetMonth}`;
    if(budgetData.find(r=>r.id===key)) return;
    setBudgetData(prev=>[...prev,mkBudgetRow(budgetBranch,budgetMonth)]);
  };

  const deleteBudgetRow=(id)=>setBudgetData(prev=>prev.filter(r=>r.id!==id));

  const deleteTask=(id)=>setTasks(prev=>prev.filter(t=>t.id!==id));
  const deleteComment=(id)=>setComments(prev=>prev.filter(c=>c.id!==id));
  const toggleCommentStatus=(id)=>setComments(prev=>prev.map(c=>c.id===id?{...c,status:c.status==="Open"?"Resolved":"Open"}:c));

  // â”€â”€â”€ BUDGET P&L NUMBERS (hooks must be before any conditional return) â”€â”€â”€
  const budgetTotals = useMemo(()=>{
    const totRevF=budgetData.reduce((s,r)=>s+(Number(r.revF)||0),0);
    const totRevA=budgetData.reduce((s,r)=>s+(Number(r.revA)||0),0);
    const totFcA=budgetData.reduce((s,r)=>s+(Number(r.fcA)||0),0);
    const totLabA=budgetData.reduce((s,r)=>s+(Number(r.labA)||0),0);
    const totEbitdaA=totRevA-totFcA-totLabA;
    const totEbitdaF=budgetData.reduce((s,r)=>s+(Number(r.revF)||0)-(Number(r.fcF)||0)-(Number(r.labF)||0),0);
    return [
      {l:"TOTAL FORECAST REV",v:totRevF.toLocaleString(),c:"#bbb"},
      {l:"TOTAL ACTUAL REV",v:totRevA.toLocaleString(),c:"#D4863A"},
      {l:"TOTAL EBITDA (F)",v:totEbitdaF.toLocaleString(),c:"#93c5fd"},
      {l:"TOTAL EBITDA (A)",v:totEbitdaA.toLocaleString(),c:totEbitdaA>0?"#4ade80":"#f87171"},
    ];
  },[budgetData]);

  const budgetSummary = useMemo(()=>{
    const summary={};
    BRANCHES.forEach(b=>{
      summary[b]={revF:0,revA:0,fcF:0,fcA:0,labF:0,labA:0,ebitdaF:0,ebitdaA:0,count:0};
    });
    budgetData.forEach(row=>{
      const s=summary[row.branch];
      if(!s) return;
      s.revF+=Number(row.revF)||0; s.revA+=Number(row.revA)||0;
      s.fcF+=Number(row.fcF)||0; s.fcA+=Number(row.fcA)||0;
      s.labF+=Number(row.labF)||0; s.labA+=Number(row.labA)||0;
      s.ebitdaF+=Number(row.ebitdaF)||0; s.ebitdaA+=Number(row.ebitdaA)||0;
      s.count++;
    });
    return summary;
  },[budgetData]);

  if(!authed) return(
    <div style={{fontFamily:sans,background:"#f5f3f0",minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center"}}>
      <div style={{textAlign:"center",maxWidth:380}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:3,marginBottom:24}}>
          <span style={{fontFamily:disp,fontSize:38,fontWeight:300,color:"#333"}}>C</span><span style={{fontFamily:disp,fontSize:26,fontWeight:300,color:"#333",position:"relative",top:-10}}>^</span><span style={{fontFamily:disp,fontSize:38,fontWeight:300,color:"#333"}}>2</span>
          <div style={{width:1,height:28,background:"#ccc",margin:"0 10px"}}/><span style={{fontFamily:disp,fontSize:11,color:"#999",letterSpacing:4,textTransform:"uppercase"}}>Fractional Management</span>
        </div>
        <p style={{fontSize:13,color:"#888",marginBottom:28}}>Abou Shakra â€” Confidential Quotation</p>
        <div style={{background:"#fff",borderRadius:12,padding:"28px 24px",boxShadow:"0 1px 4px rgba(0,0,0,0.06)",border:"1px solid #e5e1dc"}}>
          <div style={{fontFamily:mono,fontSize:10,color:"#999",letterSpacing:1.5,marginBottom:12}}>ENTER PASSWORD</div>
          <input type="password" value={pw} onChange={e=>{setPw(e.target.value);setPwErr(false)}} onKeyDown={e=>e.key==="Enter"&&handleLogin()} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style={{width:"100%",padding:"12px 14px",border:pwErr?"1.5px solid #dc2626":"1.5px solid #ddd",borderRadius:8,fontSize:14,fontFamily:mono,background:"#fafaf8",boxSizing:"border-box"}}/>
          {pwErr&&<div style={{color:"#dc2626",fontSize:12,marginTop:6}}>Incorrect password</div>}
          <button onClick={handleLogin} style={{width:"100%",marginTop:14,padding:"11px",background:"#333",color:"#fff",border:"none",borderRadius:8,fontSize:13,fontWeight:700,fontFamily:sans}}>Access Dashboard</button>
        </div>
        <p style={{fontFamily:mono,fontSize:9,color:"#bbb",marginTop:16}}>QT-AS-2026-001 Â· Confidential</p>
      </div>
    </div>
  );

  // â”€â”€â”€ TASK CARD â”€â”€â”€
  const TaskCard=({t})=>{
    const tier=T[t.tier],dept=D[t.dept],imp=IMP[t.impact],pr=PRIO[t.prio],isOpen=expTask===t.id;
    const depT=t.deps.map(d=>tasks.find(x=>x.id===d)).filter(Boolean);
    const enT=(t.enables||[]).map(d=>tasks.find(x=>x.id===d)).filter(Boolean);
    const isCustom=t.id>100;
    return(
      <div onClick={()=>setExpTask(isOpen?null:t.id)} style={{background:"#fff",border:isOpen?"1.5px solid "+dept.c+"40":"1px solid #eee",borderRadius:8,padding:"9px 12px",cursor:"pointer",borderLeft:"3px solid "+pr.c,marginBottom:3}}>
        <div style={{display:"flex",alignItems:"center",gap:6}}>
          <span style={{fontFamily:mono,fontSize:9,color:"#ccc",width:18,textAlign:"right",flexShrink:0}}>#{t.id}</span>
          <div style={{flex:1,minWidth:0}}>
            <div style={{fontSize:11.5,fontWeight:700,color:"#222"}}>{t.name}{isCustom&&<span style={{marginLeft:5,fontFamily:mono,fontSize:7.5,color:"#7c3aed",background:"#faf5ff",padding:"1px 4px",borderRadius:2}}>CUSTOM</span>}</div>
            <div style={{display:"flex",gap:4,marginTop:2,alignItems:"center",flexWrap:"wrap"}}>
              <span style={{fontFamily:mono,fontSize:7.5,color:pr.c,background:pr.tag,padding:"1px 5px",borderRadius:2,fontWeight:700}}>{pr.ico} {pr.short}</span>
              <span style={{fontFamily:mono,fontSize:8,color:tier.c,background:tier.tag,padding:"1px 5px",borderRadius:2}}>{tier.ico} {tier.l}</span>
              <span style={{fontFamily:mono,fontSize:8,color:"#999"}}>W{t.w[0]}{t.w[1]!==t.w[0]?`â€“${t.w[1]}`:""} Â· {t.hrs}h Â· EGP {(t.hrs*RATE).toLocaleString()}</span>
            </div>
          </div>
          <div style={{display:"flex",gap:2,flexShrink:0}}>{[1,2,3].map(i=><div key={i} style={{width:3,height:9,borderRadius:1,background:i<=imp.n?imp.c:"#ddd"}}/>)}</div>
          {isCustom&&<button onClick={e=>{e.stopPropagation();deleteTask(t.id)}} style={{background:"#fee2e2",border:"none",borderRadius:3,padding:"2px 5px",fontSize:9,color:"#dc2626",fontFamily:mono}}>âœ•</button>}
          <span style={{fontSize:9,color:"#bbb",transform:isOpen?"rotate(180deg)":"",transition:"0.15s"}}>â–¾</span>
        </div>
        {isOpen&&<div style={{marginTop:8,paddingTop:8,borderTop:"1px solid #f0f0ee"}} onClick={e=>e.stopPropagation()}>
          <p style={{fontSize:11,color:"#555",lineHeight:1.6,margin:"0 0 8px",paddingLeft:24}}>{t.desc}</p>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:4,paddingLeft:24,marginBottom:6}}>
            <div style={{background:"#eff6ff",borderRadius:5,padding:"6px 8px",border:"1px solid #dbeafe"}}>
              <div style={{fontFamily:mono,fontSize:7,color:"#1e40af",letterSpacing:1,marginBottom:2}}>ðŸ“Š P&L</div>
              <div style={{fontSize:9.5,color:"#1e40af",lineHeight:1.5}}>{t.pnl}</div>
            </div>
            <div style={{background:"#f0fdf4",borderRadius:5,padding:"6px 8px",border:"1px solid #bbf7d0"}}>
              <div style={{fontFamily:mono,fontSize:7,color:"#16653a",letterSpacing:1,marginBottom:2}}>ðŸ¦ BAL. SHEET</div>
              <div style={{fontSize:9.5,color:"#16653a",lineHeight:1.5}}>{t.bs}</div>
            </div>
            <div style={{background:"#fefce8",borderRadius:5,padding:"6px 8px",border:"1px solid #fde68a"}}>
              <div style={{fontFamily:mono,fontSize:7,color:"#a16207",letterSpacing:1,marginBottom:2}}>ðŸ’µ CASH FLOW</div>
              <div style={{fontSize:9.5,color:"#a16207",lineHeight:1.5}}>{t.cf}</div>
            </div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:4,paddingLeft:24}}>
            <div style={{background:"#fafaf8",borderRadius:5,padding:"5px 8px",border:"1px solid #eee"}}>
              <div style={{fontFamily:mono,fontSize:7,color:"#999",letterSpacing:1,marginBottom:2}}>â¬† DEPENDS ON ({depT.length})</div>
              {depT.length===0?<div style={{fontSize:9,color:"#ccc"}}>No dependencies</div>:depT.map(d=><div key={d.id} style={{fontSize:9,color:"#666"}}>#{d.id} {d.name}</div>)}
            </div>
            <div style={{background:"#eff6ff",borderRadius:5,padding:"5px 8px",border:"1px solid #dbeafe"}}>
              <div style={{fontFamily:mono,fontSize:7,color:"#1e40af",letterSpacing:1,marginBottom:2}}>â¬‡ ENABLES ({enT.length})</div>
              {enT.length===0?<div style={{fontSize:9,color:"#93c5fd"}}>Terminal deliverable</div>:enT.map(d=><div key={d.id} style={{fontSize:9,color:"#1e40af"}}>#{d.id} {d.name}</div>)}
            </div>
          </div>
        </div>}
      </div>
    );
  };

  const inputStyle={width:"100%",padding:"5px 7px",border:"1px solid #ddd",borderRadius:4,fontSize:11,fontFamily:mono,background:"#fafaf8"};
  const labelStyle={fontFamily:mono,fontSize:8,color:"#999",letterSpacing:1,marginBottom:3};

  return(
    <div style={{fontFamily:sans,background:"#f5f3f0",color:"#333",minHeight:"100vh"}}>
      {/* HEADER */}
      <div style={{background:"#fff",borderBottom:"1px solid #e5e1dc",padding:"16px 24px 12px"}}>
        <div style={{maxWidth:1100,margin:"0 auto",display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:10}}>
          <div>
            <div style={{display:"flex",alignItems:"center",gap:3,marginBottom:6}}>
              <span style={{fontFamily:disp,fontSize:22,fontWeight:300}}>C</span><span style={{fontFamily:disp,fontSize:15,fontWeight:300,position:"relative",top:-5}}>^</span><span style={{fontFamily:disp,fontSize:22,fontWeight:300}}>2</span>
              <div style={{width:1,height:16,background:"#ddd",margin:"0 6px"}}/><span style={{fontFamily:disp,fontSize:9,color:"#999",letterSpacing:3,textTransform:"uppercase"}}>Fractional Management</span>
            </div>
            <h1 style={{fontFamily:disp,fontSize:18,fontWeight:700,color:"#1a1a1a",margin:"0 0 2px"}}>Abou Shakra â€” F&B Financial Turnaround</h1>
            <p style={{fontFamily:mono,fontSize:9.5,color:"#aaa",margin:0}}>QT-AS-2026-001 Â· Feb 2026 Â· Valid 30 days</p>
          </div>
          <div style={{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"}}>
            <div style={{textAlign:"right"}}>
              <div style={{fontFamily:mono,fontSize:8,color:"#bbb",letterSpacing:1}}>ANNUAL REVENUE</div>
              <div style={{fontFamily:disp,fontSize:22,fontWeight:800,lineHeight:1}}>EGP 120M</div>
              <div style={{fontFamily:mono,fontSize:9,color:"#dc2626",fontWeight:600}}>Current EBITDA: Negative</div>
            </div>
            <button onClick={()=>exportToExcel(tasks,opsMonthly,dealMonthly,budgetData,comments)} style={{display:"flex",alignItems:"center",gap:5,padding:"9px 14px",background:"#16653a",color:"#fff",border:"none",borderRadius:7,fontSize:11,fontWeight:700,fontFamily:sans,boxShadow:"0 1px 3px rgba(0,0,0,0.15)"}}>
              <span>â¬‡</span> Export Excel
            </button>
          </div>
        </div>
      </div>

      <div style={{maxWidth:1100,margin:"0 auto",padding:"14px 24px"}}>
        {/* NAV */}
        <div style={{display:"flex",gap:2,marginBottom:14,background:"#fff",borderRadius:7,padding:3,width:"fit-content",border:"1px solid #e5e1dc",flexWrap:"wrap"}}>
          {[["overview","Overview"],["buckets","Engagement Buckets"],["timeline","Timeline"],["pricing","Monthly Pricing"],["success","Success Fees"],["market","Market Comparison"],["budget","Budget vs Actual"],["notes","Comments & Tasks"],["mktplan","ðŸŒ™ Ramadan Sales Plan"],["reqs","Requirements"]].map(([k,l])=>(
            <button key={k} onClick={()=>setView(k)} style={{fontFamily:sans,padding:"5px 11px",borderRadius:5,border:"none",background:view===k?"#333":"transparent",color:view===k?"#fff":"#999",fontSize:10.5,fontWeight:700,cursor:"pointer",position:"relative"}}>
              {l}
              {k==="notes"&&comments.filter(c=>c.status==="Open").length>0&&<span style={{position:"absolute",top:1,right:1,width:6,height:6,borderRadius:"50%",background:"#dc2626"}}/>}
            </button>
          ))}
        </div>

        {/* â•â•â• OVERVIEW â•â•â• */}
        {view==="overview"&&<div>
          <div style={{background:"#fff",border:"1px solid #fecaca",borderLeft:"4px solid #dc2626",borderRadius:8,padding:"14px 16px",marginBottom:12}}>
            <div style={{fontFamily:disp,fontSize:14,fontWeight:700,color:"#dc2626",marginBottom:4}}>The Situation</div>
            <div style={{fontSize:12,color:"#555",lineHeight:1.7}}>Abou Shakra generates <strong>EGP 120M</strong> in annual revenue but operates at <strong>negative EBITDA</strong>. Revenue is not the problem â€” financial controls, cost visibility, and operational discipline are. This engagement moves EBITDA from negative to <strong>+10%</strong>, creating <strong>EGP 12M+</strong> in annual profit.</div>
          </div>
          <div style={{background:"#fef2f2",border:"1px solid #fecaca",borderLeft:"4px solid #dc2626",borderRadius:8,padding:"12px 16px",marginBottom:12,display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10}}>
            <div>
              <div style={{fontFamily:mono,fontSize:8,color:"#dc2626",letterSpacing:1,marginBottom:3}}>ðŸ”¥ MONTH 1 TOTAL HOURS</div>
              <div style={{fontFamily:disp,fontSize:20,fontWeight:800,color:"#dc2626"}}>160h</div>
              <div style={{fontFamily:mono,fontSize:8.5,color:"#888"}}>Hard cap â€” full availability</div>
            </div>
            <div>
              <div style={{fontFamily:mono,fontSize:8,color:"#dc2626",letterSpacing:1,marginBottom:3}}>âš¡ FIREFIGHTING (50%)</div>
              <div style={{fontFamily:disp,fontSize:20,fontWeight:800,color:"#dc2626"}}>80h</div>
              <div style={{fontFamily:mono,fontSize:8.5,color:"#888"}}>Suppliers Â· Tax Â· Customers Â· Partners</div>
            </div>
            <div>
              <div style={{fontFamily:mono,fontSize:8,color:"#1e40af",letterSpacing:1,marginBottom:3}}>ðŸ“‹ DELIVERABLES (50%)</div>
              <div style={{fontFamily:disp,fontSize:20,fontWeight:800,color:"#1e40af"}}>80h</div>
              <div style={{fontFamily:mono,fontSize:8.5,color:"#888"}}>Revenue â†’ Cost â†’ Cash priority</div>
            </div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:6,marginBottom:14}}>
            {[{l:"Buckets",v:"5",s:"4 ops + 1 deal"},{l:"Tasks",v:String(tasks.length),s:"Deliverables"},{l:"M1 Cap",v:"160h",s:"80h firefighting + 80h work"},{l:"Retainer",v:"192K",s:"EGP/mo Month 1"},{l:"Target",v:"10%+",s:"EBITDA margin"}].map((s,i)=>(
              <div key={i} style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:8,padding:"10px 12px"}}>
                <div style={{fontFamily:mono,fontSize:8,color:"#aaa",letterSpacing:1,marginBottom:3}}>{s.l}</div>
                <div style={{fontFamily:disp,fontSize:20,fontWeight:800,lineHeight:1}}>{s.v}</div>
                <div style={{fontFamily:mono,fontSize:8.5,color:"#bbb",marginTop:2}}>{s.s}</div>
              </div>
            ))}
          </div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:6,marginBottom:8}}>
            {buckets.slice(0,3).map(b=>{const bt=tasks.filter(t=>t.b===b.id);const ti=T[b.tier];
              return <div key={b.id} style={{background:"#fff",border:"1px solid "+b.bdr,borderLeft:"4px solid "+b.color,borderRadius:8,padding:"12px 14px"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
                  <span style={{fontSize:16}}>{b.ico}</span>
                  <span style={{fontFamily:mono,fontSize:8,color:ti.c,background:ti.tag,padding:"1px 5px",borderRadius:3}}>{ti.l}</span>
                </div>
                <div style={{fontFamily:disp,fontSize:12,fontWeight:700,color:"#222",marginBottom:2}}>{b.name}</div>
                <div style={{fontFamily:mono,fontSize:9,color:"#999"}}>{bt.length} tasks Â· {bt.reduce((s,t)=>s+t.hrs,0)}h Â· Wk {b.weeks}</div>
              </div>;
            })}
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginBottom:14}}>
            {buckets.slice(3).map(b=>{const bt=tasks.filter(t=>t.b===b.id);const ti=T[b.tier];
              return <div key={b.id} style={{background:"#fff",border:"1px solid "+b.bdr,borderLeft:"4px solid "+b.color,borderRadius:8,padding:"12px 14px"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
                  <span style={{fontSize:16}}>{b.ico}</span>
                  <span style={{fontFamily:mono,fontSize:8,color:ti.c,background:ti.tag,padding:"1px 5px",borderRadius:3}}>{ti.l}</span>
                </div>
                <div style={{fontFamily:disp,fontSize:12,fontWeight:700,color:"#222",marginBottom:2}}>{b.name}</div>
                <div style={{fontFamily:mono,fontSize:9,color:"#999"}}>{bt.length} tasks Â· {bt.reduce((s,t)=>s+t.hrs,0)}h Â· Wk {b.weeks}</div>
              </div>;
            })}
          </div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:6}}>
            {opsMonthly.map((m,i)=>(
              <div key={i} style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:8,padding:"12px 14px"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
                  <span style={{fontFamily:disp,fontSize:13,fontWeight:700}}>{m.label}</span>
                  <span style={{fontFamily:mono,fontSize:8.5,color:"#aaa"}}>{m.wks}</span>
                </div>
                <div style={{fontFamily:disp,fontSize:20,fontWeight:800}}>EGP {m.retainer.toLocaleString()}</div>
                <div style={{fontFamily:mono,fontSize:9,color:"#bbb"}}>{m.hrs}h Ã— EGP {RATE.toLocaleString()} = EGP {m.computed.toLocaleString()}{m.isFloor?" â†’ 100K min":""}</div>
              </div>
            ))}
          </div>
        </div>}

        {/* â•â•â• BUCKETS â•â•â• */}
        {view==="buckets"&&<div>
          <div style={{display:"flex",gap:6,marginBottom:12,flexWrap:"wrap"}}>
            {Object.entries(PRIO).map(([k,p])=>(
              <div key={k} style={{display:"flex",alignItems:"center",gap:5,padding:"5px 10px",background:p.bg,border:"1px solid "+p.bdr,borderRadius:6}}>
                <span style={{fontSize:11}}>{p.ico}</span>
                <span style={{fontFamily:mono,fontSize:8.5,color:p.c,fontWeight:700}}>{p.l}</span>
              </div>
            ))}
          </div>
          {buckets.map(b=>{
            const bt=tasks.filter(t=>t.b===b.id).slice().sort(prioSort);
            const ti=T[b.tier],isOpen=expBucket===b.id;
            const bh=bt.reduce((s,t)=>s+t.hrs,0);
            const groups=[{key:"rev",tasks:bt.filter(t=>t.prio==="rev")},{key:"cost",tasks:bt.filter(t=>t.prio==="cost")},{key:"cash",tasks:bt.filter(t=>t.prio==="cash")}].filter(g=>g.tasks.length>0);
            return <div key={b.id} style={{background:"#fff",border:isOpen?"1.5px solid "+b.color+"50":"1px solid #e5e1dc",borderRadius:10,padding:"14px 16px",marginBottom:6,borderLeft:"4px solid "+b.color}}>
              <div onClick={()=>{setExpBucket(isOpen?null:b.id);setExpTask(null)}} style={{cursor:"pointer"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                  <div style={{flex:1}}>
                    <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:5}}>
                      <span style={{fontSize:18}}>{b.ico}</span>
                      <span style={{fontFamily:disp,fontSize:15,fontWeight:700,color:"#222"}}>{b.name}</span>
                      <span style={{fontFamily:mono,fontSize:8.5,color:ti.c,background:ti.tag,padding:"2px 6px",borderRadius:3,fontWeight:600}}>{ti.ico} {ti.l}</span>
                    </div>
                    <div style={{display:"flex",gap:4,marginBottom:6,flexWrap:"wrap"}}>
                      {b.impactPills.map((pill,pi)=>{const pr=PRIO[pill.p];return(
                        <div key={pi} style={{display:"flex",alignItems:"center",gap:3,padding:"3px 7px",background:pr.bg,border:"1px solid "+pr.bdr,borderRadius:4}}>
                          <span style={{fontSize:9}}>{pr.ico}</span>
                          <span style={{fontFamily:mono,fontSize:8,color:pr.c,fontWeight:700}}>{pill.v}</span>
                          <span style={{fontFamily:mono,fontSize:7.5,color:pr.c,opacity:0.75}}>{pill.l}</span>
                        </div>
                      );})}
                    </div>
                    <div style={{fontFamily:mono,fontSize:9.5,color:"#999",marginBottom:4}}>Week {b.weeks} Â· {bt.length} tasks Â· {bh} hours Â· EGP {(bh*RATE).toLocaleString()}</div>
                    <div style={{fontSize:11.5,color:"#555",lineHeight:1.6}}>{b.desc}</div>
                  </div>
                  <span style={{fontSize:12,color:"#bbb",transform:isOpen?"rotate(180deg)":"",transition:"0.15s",marginLeft:10,flexShrink:0,marginTop:4}}>â–¾</span>
                </div>
              </div>
              {isOpen&&<div style={{marginTop:12,paddingTop:12,borderTop:"1px solid "+b.bdr}}>
                {/* B8 Incentive Inputs Panel */}
                {b.id==="B8"&&<div style={{background:"#fffbeb",border:"1px solid #fcd34d",borderRadius:8,padding:"14px 16px",marginBottom:12}}>
                  <div style={{fontFamily:disp,fontSize:12,fontWeight:700,color:"#d97706",marginBottom:3}}>ðŸŽ› Incentive Scheme Inputs â€” Update as data becomes available</div>
                  <div style={{fontFamily:mono,fontSize:8.5,color:"#92400e",marginBottom:10}}>These inputs drive the commission calculations below. Fill in as you get actuals from branches.</div>
                  <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(220px,1fr))",gap:8,marginBottom:12}}>
                    {[
                      {label:"Branch Mgr Base Salary (EGP/mo)",key:"branchMgrBase",type:"number"},
                      {label:"Floor Supervisor Base (EGP/mo)",key:"floorSupBase",type:"number"},
                      {label:"Waiter Base Salary (EGP/mo)",key:"waiterBase",type:"number"},
                      {label:"QC Coordinator Base (EGP/mo)",key:"qcBase",type:"number"},
                      {label:"Host/Reservations Base (EGP/mo)",key:"hostBase",type:"number"},
                      {label:"Sales Manager Base (EGP/mo)",key:"salesMgrBase",type:"number"},
                      {label:"Avg Monthly Revenue / Branch (EGP)",key:"avgMonthlyRevPerBranch",type:"number"},
                      {label:"Average Check Target (EGP)",key:"avgCheckTarget",type:"number"},
                      {label:"Estimated Covers / Month / Branch",key:"coversPerMonth",type:"number"},
                      {label:"Food Cost Target (%)",key:"foodCostTarget",type:"number"},
                      {label:"QC Revenue as % of Total",key:"qcRevenueShare",type:"number"},
                    ].map(({label,key,type})=>(
                      <div key={key}>
                        <div style={{fontFamily:mono,fontSize:7.5,color:"#92400e",letterSpacing:1,marginBottom:3}}>{label.toUpperCase()}</div>
                        <input type={type} value={incentiveInputs[key]} onChange={e=>setIncentiveInputs(p=>({...p,[key]:Number(e.target.value)}))}
                          style={{width:"100%",padding:"5px 8px",border:"1px solid #fcd34d",borderRadius:4,fontFamily:mono,fontSize:11,background:"#fff",boxSizing:"border-box"}}/>
                      </div>
                    ))}
                  </div>
                  <div style={{fontFamily:disp,fontSize:12,fontWeight:700,color:"#d97706",marginBottom:8}}>Commission Structure</div>
                  <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(220px,1fr))",gap:8,marginBottom:12}}>
                    {[
                      {label:"Branch Mgr Commission % of EBITDA uplift",key:"commissionPct"},
                      {label:"Accelerator at 110% target (%)",key:"accelerator110"},
                      {label:"Accelerator at 125% target (%)",key:"accelerator125"},
                    ].map(({label,key})=>(
                      <div key={key}>
                        <div style={{fontFamily:mono,fontSize:7.5,color:"#92400e",letterSpacing:1,marginBottom:3}}>{label.toUpperCase()}</div>
                        <input type="number" value={incentiveInputs[key]} onChange={e=>setIncentiveInputs(p=>({...p,[key]:Number(e.target.value)}))}
                          style={{width:"100%",padding:"5px 8px",border:"1px solid #fcd34d",borderRadius:4,fontFamily:mono,fontSize:11,background:"#fff",boxSizing:"border-box"}}/>
                      </div>
                    ))}
                  </div>
                  <div style={{fontFamily:disp,fontSize:12,fontWeight:700,color:"#d97706",marginBottom:8}}>KPI Bonus Amounts (EGP)</div>
                  <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(220px,1fr))",gap:8,marginBottom:12}}>
                    {[
                      {label:"Avg Check Uplift Bonus (per branch mgr)",key:"avgCheckBonus"},
                      {label:"Food Cost Below Target Bonus",key:"foodCostBonus"},
                      {label:"Customer Review Score Bonus",key:"reviewBonus"},
                      {label:"Upsell Rate Bonus (per waiter/week)",key:"upsellBonus"},
                      {label:"Leaderboard 1st Place (team)",key:"leaderboardFirst"},
                      {label:"Leaderboard 2nd Place (team)",key:"leaderboardSecond"},
                      {label:"Leaderboard 3rd Place (team)",key:"leaderboardThird"},
                    ].map(({label,key})=>(
                      <div key={key}>
                        <div style={{fontFamily:mono,fontSize:7.5,color:"#92400e",letterSpacing:1,marginBottom:3}}>{label.toUpperCase()}</div>
                        <input type="number" value={incentiveInputs[key]} onChange={e=>setIncentiveInputs(p=>({...p,[key]:Number(e.target.value)}))}
                          style={{width:"100%",padding:"5px 8px",border:"1px solid #fcd34d",borderRadius:4,fontFamily:mono,fontSize:11,background:"#fff",boxSizing:"border-box"}}/>
                      </div>
                    ))}
                  </div>
                  {/* Live calculated outputs */}
                  <div style={{fontFamily:disp,fontSize:12,fontWeight:700,color:"#d97706",marginBottom:8}}>ðŸ“Š Calculated Scheme Outputs (per branch, per month)</div>
                  <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))",gap:8}}>
                    {(()=>{
                      const revTarget = incentiveInputs.avgMonthlyRevPerBranch;
                      const ebitdaUpliftEst = revTarget * 0.03; // assume 3% EBITDA improvement
                      const mgrComm = ebitdaUpliftEst * (incentiveInputs.commissionPct/100);
                      const mgrComm110 = ebitdaUpliftEst * (incentiveInputs.accelerator110/100);
                      const mgrComm125 = ebitdaUpliftEst * (incentiveInputs.accelerator125/100);
                      const totalBonusPool = incentiveInputs.avgCheckBonus + incentiveInputs.foodCostBonus + incentiveInputs.reviewBonus + (incentiveInputs.upsellBonus * 4 * 5); // 4 weeks, ~5 waiters
                      const maxMonthlyPayout = mgrComm125 + totalBonusPool + (incentiveInputs.leaderboardFirst/8);
                      const roiMultiple = revTarget * 0.05 / Math.max(maxMonthlyPayout, 1);
                      return [
                        {l:"Est. Branch Mgr Commission (base)",v:`EGP ${Math.round(mgrComm).toLocaleString()}`,c:"#16653a"},
                        {l:"At 110% Target",v:`EGP ${Math.round(mgrComm110).toLocaleString()}`,c:"#a16207"},
                        {l:"At 125% Target",v:`EGP ${Math.round(mgrComm125).toLocaleString()}`,c:"#1e40af"},
                        {l:"Monthly KPI Bonus Pool",v:`EGP ${Math.round(totalBonusPool).toLocaleString()}`,c:"#7c3aed"},
                        {l:"Max Monthly Payout / Branch",v:`EGP ${Math.round(maxMonthlyPayout).toLocaleString()}`,c:"#dc2626"},
                        {l:"Scheme ROI (5% uplift / max payout)",v:`${Math.round(roiMultiple)}x`,c:roiMultiple>3?"#16653a":"#dc2626"},
                      ].map((s,i)=>(
                        <div key={i} style={{background:"#fff",borderRadius:6,padding:"10px 12px",border:"1px solid #fde68a"}}>
                          <div style={{fontFamily:mono,fontSize:7.5,color:"#92400e",letterSpacing:1,marginBottom:2}}>{s.l.toUpperCase()}</div>
                          <div style={{fontFamily:disp,fontSize:16,fontWeight:800,color:s.c}}>{s.v}</div>
                        </div>
                      ));
                    })()}
                  </div>
                </div>}

                {/* B7 Marketing Funnel Summary */}
                {b.id==="B7"&&<div style={{background:"#fdf2f8",border:"1px solid #f9a8d4",borderRadius:8,padding:"14px 16px",marginBottom:12}}>
                  <div style={{fontFamily:disp,fontSize:12,fontWeight:700,color:"#be185d",marginBottom:8}}>ðŸ“Š Funnel Conversion Targets â€” F&B Egypt Benchmarks</div>
                  <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(200px,1fr))",gap:8,marginBottom:10}}>
                    {[
                      {stage:"Impressions â†’ Profile Visit",bench:"2â€“5%",target:"4%+",c:"#1e40af"},
                      {stage:"Profile Visit â†’ Menu View / Order",bench:"30â€“50%",target:"45%+",c:"#a16207"},
                      {stage:"Menu View â†’ Order / Cover",bench:"5â€“15%",target:"12%+",c:"#16653a"},
                      {stage:"First Visit â†’ Repeat (30 days)",bench:"20â€“35%",target:"40%+",c:"#7c3aed"},
                      {stage:"Repeat â†’ Loyal (5+ visits/yr)",bench:"10â€“20%",target:"20%+",c:"#be185d"},
                      {stage:"Average Order Value Growth",bench:"Market flat",target:"+15% YoY",c:"#dc2626"},
                    ].map((m,i)=>(
                      <div key={i} style={{background:"#fff",borderRadius:6,padding:"8px 10px",borderLeft:"3px solid "+m.c}}>
                        <div style={{fontFamily:sans,fontSize:9.5,color:"#666",marginBottom:4}}>{m.stage}</div>
                        <div style={{display:"flex",justifyContent:"space-between"}}>
                          <div><div style={{fontFamily:mono,fontSize:7,color:"#999",letterSpacing:1}}>BENCHMARK</div><div style={{fontFamily:disp,fontSize:13,fontWeight:700,color:"#aaa"}}>{m.bench}</div></div>
                          <div style={{textAlign:"right"}}><div style={{fontFamily:mono,fontSize:7,color:"#999",letterSpacing:1}}>TARGET</div><div style={{fontFamily:disp,fontSize:13,fontWeight:700,color:m.c}}>{m.target}</div></div>
                        </div>
                      </div>
                    ))}
                  </div>
                  <div style={{fontFamily:mono,fontSize:8.5,color:"#be185d"}}>âš  Funnel conversion data will be populated once CRM, GMB analytics, and POS data are connected (W3â€“5)</div>
                </div>}

                {groups.map(g=>{const pr=PRIO[g.key];return(
                  <div key={g.key} style={{marginBottom:8}}>
                    <div style={{display:"flex",alignItems:"center",gap:5,padding:"4px 8px",background:pr.bg,borderRadius:5,marginBottom:4,borderLeft:"3px solid "+pr.c}}>
                      <span style={{fontSize:10}}>{pr.ico}</span>
                      <span style={{fontFamily:mono,fontSize:8,color:pr.c,fontWeight:700,letterSpacing:0.5}}>{pr.l.toUpperCase()}</span>
                      <span style={{fontFamily:mono,fontSize:7.5,color:pr.c,opacity:0.7}}>Â· {g.tasks.length} task{g.tasks.length>1?"s":""} Â· {g.tasks.reduce((s,t)=>s+t.hrs,0)}h</span>
                    </div>
                    {g.tasks.map(t=><TaskCard key={t.id} t={t}/>)}
                  </div>
                );})}
                <div style={{display:"flex",justifyContent:"flex-end",padding:"6px 10px",background:"#fafaf8",borderRadius:5,marginTop:4}}>
                  <span style={{fontFamily:mono,fontSize:9,color:"#888"}}>{bt.length} tasks Â· {bh}h Â· </span>
                  <span style={{fontFamily:disp,fontSize:11,fontWeight:800,color:b.color,marginLeft:4}}>EGP {(bh*RATE).toLocaleString()}</span>
                </div>
              </div>}
            </div>;
          })}
        </div>}

        {/* â•â•â• TIMELINE â•â•â• */}
        {view==="timeline"&&<div style={{overflowX:"auto"}}>
          <div style={{display:"flex",gap:6,marginBottom:8,flexWrap:"wrap"}}>
            {Object.entries(PRIO).map(([k,p])=>(
              <div key={k} style={{display:"flex",alignItems:"center",gap:4,padding:"3px 8px",background:p.bg,border:"1px solid "+p.bdr,borderRadius:4}}>
                <div style={{width:12,height:6,borderRadius:2,background:p.c}}/>
                <span style={{fontFamily:mono,fontSize:8,color:p.c,fontWeight:700}}>{p.ico} {p.l}</span>
              </div>
            ))}
            <div style={{display:"flex",alignItems:"center",gap:4,padding:"3px 8px",background:"#fef2f2",border:"1px solid #fecaca",borderRadius:4}}>
              <div style={{width:12,height:6,borderRadius:2,background:"#dc2626"}}/>
              <span style={{fontFamily:mono,fontSize:8,color:"#dc2626",fontWeight:700}}>ðŸ”¥ Firefighting (M1 reserved)</span>
            </div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"190px repeat(12,1fr)",gap:0,marginBottom:4}}>
            <div style={{padding:"5px 6px"}}><span style={{fontFamily:mono,fontSize:8,color:"#aaa"}}>BUCKET / TASK</span></div>
            {WEEKS.map(w=>{const ms=[{w:4,c:"#dc2626",l:"M1"},{w:8,c:"#a16207",l:"M2"},{w:12,c:"#1e40af",l:"M3"}].find(m=>m.w===w);
              return <div key={w} style={{textAlign:"center",padding:"3px 1px"}}>
                <div style={{fontFamily:mono,fontSize:8,color:ms?ms.c:"#bbb",fontWeight:ms?700:400}}>W{w}</div>
                {ms&&<div style={{fontFamily:mono,fontSize:6,color:ms.c}}>{ms.l}</div>}
              </div>;
            })}
          </div>
          <div style={{display:"grid",gridTemplateColumns:"190px repeat(12,1fr)",gap:0,marginBottom:4}}>
            <div style={{padding:"3px 6px",display:"flex",alignItems:"center",gap:3}}>
              <span style={{fontFamily:mono,fontSize:7.5,color:"#dc2626",fontWeight:700}}>ðŸ”¥ FIREFIGHTING</span>
            </div>
            {WEEKS.map(w=>(
              <div key={w} style={{padding:"2px 1px",display:"flex",alignItems:"center"}}>
                {w<=4&&<div style={{width:"100%",height:10,background:"#fca5a540",borderLeft:w===1?"2px solid #dc2626":"none",borderRadius:w===1&&4?"3px":w===1?"3px 0 0 3px":w===4?"0 3px 3px 0":0,display:"flex",alignItems:"center",justifyContent:"center"}}>
                  {w===1&&<span style={{fontFamily:mono,fontSize:6,color:"#dc2626",fontWeight:700}}>80h</span>}
                </div>}
              </div>
            ))}
          </div>
          {buckets.map(b=>{
            const bt=tasks.filter(t=>t.b===b.id).slice().sort(prioSort);
            return <div key={b.id} style={{marginBottom:3}}>
              <div style={{display:"grid",gridTemplateColumns:"190px repeat(12,1fr)",gap:0,marginBottom:1}}>
                <div style={{padding:"4px 6px",background:b.bg,borderRadius:"4px 0 0 4px",borderLeft:"3px solid "+b.color,display:"flex",alignItems:"center",gap:3}}>
                  <span style={{fontSize:10}}>{b.ico}</span>
                  <span style={{fontFamily:mono,fontSize:7.5,color:b.color,fontWeight:700}}>{b.name.toUpperCase()}</span>
                </div>
                {WEEKS.map(w=><div key={w} style={{background:b.bg,borderRadius:w===12?"0 4px 4px 0":0}}/>)}
              </div>
              {bt.map(t=>{
                const pr=PRIO[t.prio],imp=IMP[t.impact],isKey=t.impact==="high"&&t.tier==="quick";
                return <div key={t.id} style={{display:"grid",gridTemplateColumns:"190px repeat(12,1fr)",gap:0,marginBottom:1}}>
                  <div style={{padding:"3px 6px",display:"flex",alignItems:"center",gap:3}}>
                    <div style={{width:4,height:4,borderRadius:"50%",background:pr.c,flexShrink:0}}/>
                    <span style={{fontFamily:mono,fontSize:7,color:"#bbb",width:14,textAlign:"right",flexShrink:0}}>{t.id}</span>
                    <div style={{display:"flex",gap:1,flexShrink:0}}>{[1,2,3].map(i=><div key={i} style={{width:2,height:7,borderRadius:1,background:i<=imp.n?imp.c:"#ddd"}}/>)}</div>
                    <span style={{fontSize:isKey?9.5:8.5,color:"#555",fontWeight:isKey?700:400,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{t.name}</span>
                  </div>
                  {WEEKS.map(w=>{const act=w>=t.w[0]&&w<=t.w[1],isS=w===t.w[0],isE=w===t.w[1];
                    return <div key={w} style={{padding:"2px 1px",display:"flex",alignItems:"center"}}>
                      {act&&<div style={{width:"100%",height:isKey?15:11,background:`${pr.c}20`,borderLeft:isS?`2px solid ${pr.c}`:"none",borderRadius:isS&&isE?"3px":isS?"3px 0 0 3px":isE?"0 3px 3px 0":0,display:"flex",alignItems:"center",justifyContent:"center"}}>
                        {isS&&<span style={{fontFamily:mono,fontSize:6,color:pr.c,fontWeight:700}}>{t.hrs}h</span>}
                      </div>}
                    </div>;
                  })}
                </div>;
              })}
            </div>;
          })}
        </div>}

        {/* â•â•â• MONTHLY PRICING â•â•â• */}
        {view==="pricing"&&<div>
          <div style={{background:"#fefce8",border:"1px solid #fde68a",borderRadius:8,padding:"12px 16px",marginBottom:10}}>
            <div style={{fontSize:12,color:"#92400e",lineHeight:1.6}}><strong>Pricing logic:</strong> Each month priced on actual hours Ã— EGP {RATE.toLocaleString()}/hr. Minimum retainer EGP {MIN_RETAINER.toLocaleString()}. Tasks ordered by financial priority: Revenue â†’ Cost â†’ Cash.</div>
          </div>
          <div style={{background:"#fef2f2",border:"1px solid #fecaca",borderLeft:"4px solid #dc2626",borderRadius:8,padding:"12px 16px",marginBottom:14}}>
            <div style={{fontFamily:mono,fontSize:9,color:"#dc2626",fontWeight:700,letterSpacing:1,marginBottom:4}}>MONTH 1 â€” HOUR ALLOCATION (160h CAP)</div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
              <div style={{background:"#fff",borderRadius:6,padding:"10px 12px",border:"1px solid #fecaca"}}>
                <div style={{fontFamily:mono,fontSize:8,color:"#dc2626",marginBottom:2}}>ðŸ”¥ FIREFIGHTING & NEGOTIATIONS</div>
                <div style={{fontFamily:disp,fontSize:22,fontWeight:800,color:"#dc2626"}}>80h</div>
                <div style={{fontSize:10,color:"#888"}}>Suppliers Â· Customers Â· Tax Â· Partners</div>
              </div>
              <div style={{background:"#fff",borderRadius:6,padding:"10px 12px",border:"1px solid #fecaca"}}>
                <div style={{fontFamily:mono,fontSize:8,color:"#1e40af",marginBottom:2}}>ðŸ“‹ STRUCTURED DELIVERABLES</div>
                <div style={{fontFamily:disp,fontSize:22,fontWeight:800,color:"#1e40af"}}>80h</div>
                <div style={{fontSize:10,color:"#888"}}>Revenue â†’ Cost â†’ Cash priority</div>
              </div>
            </div>
          </div>

          <div style={{fontFamily:disp,fontSize:14,fontWeight:700,color:"#222",marginBottom:8}}>Operations Engagement</div>
          {opsMonthly.map((m,mi)=>{
            const sorted=m.tasks.slice().sort(prioSort);
            const groups=[{key:"rev",tasks:sorted.filter(t=>t.prio==="rev")},{key:"cost",tasks:sorted.filter(t=>t.prio==="cost")},{key:"cash",tasks:sorted.filter(t=>t.prio==="cash")}].filter(g=>g.tasks.length>0);
            return <div key={mi} style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:10,padding:"14px 16px",marginBottom:8}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
                <div>
                  <div style={{fontFamily:disp,fontSize:15,fontWeight:700}}>{m.label}</div>
                  <div style={{fontFamily:mono,fontSize:9.5,color:"#aaa"}}>{m.wks} Â· {m.tasks.length} active tasks{mi===0?" Â· 80h firefighting reserved":""}</div>
                </div>
                <div style={{textAlign:"right"}}>
                  <div style={{fontFamily:disp,fontSize:24,fontWeight:800}}>EGP {m.retainer.toLocaleString()}</div>
                  <div style={{fontFamily:mono,fontSize:9,color:m.isFloor?"#D4863A":"#bbb"}}>{m.hrs}h Ã— EGP {RATE.toLocaleString()} = EGP {m.computed.toLocaleString()}{m.isFloor?" â†’ min retainer":""}</div>
                </div>
              </div>
              {mi===0&&<div style={{display:"grid",gridTemplateColumns:"20px 1fr 60px 42px 70px",gap:4,alignItems:"center",padding:"5px 6px",background:"#fef2f2",borderRadius:4,marginBottom:6,border:"1px solid #fecaca"}}>
                <span style={{fontFamily:mono,fontSize:10,color:"#dc2626",textAlign:"right"}}>ðŸ”¥</span>
                <span style={{fontSize:10,color:"#dc2626",fontWeight:700}}>Firefighting & Counter-Party Negotiations</span>
                <span style={{fontFamily:mono,fontSize:7.5,color:"#dc2626",background:"#fee2e2",padding:"1px 3px",borderRadius:2,textAlign:"center"}}>Reserved</span>
                <span style={{fontFamily:mono,fontSize:8.5,color:"#dc2626",textAlign:"center",fontWeight:700}}>{M1_FIREFIGHT}h</span>
                <span style={{fontFamily:mono,fontSize:8.5,color:"#dc2626",textAlign:"right",fontWeight:700}}>EGP {(M1_FIREFIGHT*RATE).toLocaleString()}</span>
              </div>}
              {groups.map(g=>{
                const pr=PRIO[g.key];
                const grpHrs=g.tasks.reduce((s,t)=>{const span=t.w[1]-t.w[0]+1;let ov=0;for(let w=m.w[0];w<=m.w[1];w++) if(w>=t.w[0]&&w<=t.w[1]) ov++;return s+Math.round(t.hrs*ov/span);},0);
                return <div key={g.key} style={{marginBottom:6}}>
                  <div style={{display:"grid",gridTemplateColumns:"20px 1fr 60px 42px 70px",gap:4,alignItems:"center",padding:"4px 6px",background:pr.bg,borderRadius:4,marginBottom:2,border:"1px solid "+pr.bdr}}>
                    <span style={{fontSize:10,textAlign:"center"}}>{pr.ico}</span>
                    <span style={{fontFamily:mono,fontSize:8,color:pr.c,fontWeight:700}}>{pr.l.toUpperCase()}</span>
                    <span style={{fontFamily:mono,fontSize:7.5,color:pr.c,background:pr.tag,padding:"1px 3px",borderRadius:2,textAlign:"center"}}>{g.tasks.length} tasks</span>
                    <span style={{fontFamily:mono,fontSize:8,color:pr.c,textAlign:"center",fontWeight:600}}>{grpHrs}h</span>
                    <span style={{fontFamily:mono,fontSize:8,color:pr.c,textAlign:"right",fontWeight:700}}>EGP {(grpHrs*RATE).toLocaleString()}</span>
                  </div>
                  {g.tasks.map(t=>{const ti=T[t.tier],span=t.w[1]-t.w[0]+1;let ov=0;
                    for(let w=m.w[0];w<=m.w[1];w++) if(w>=t.w[0]&&w<=t.w[1]) ov++;
                    const mh=Math.round(t.hrs*ov/span);
                    return <div key={t.id} style={{display:"grid",gridTemplateColumns:"20px 1fr 60px 42px 70px",gap:4,alignItems:"center",padding:"3px 6px",background:"#fafaf8",borderRadius:3,marginBottom:1,border:"1px solid #f0f0ee",borderLeft:"2px solid "+pr.c+"30"}}>
                      <span style={{fontFamily:mono,fontSize:8,color:"#ccc",textAlign:"right"}}>{t.id}</span>
                      <span style={{fontSize:10,color:"#555",fontWeight:500,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{t.name}</span>
                      <span style={{fontFamily:mono,fontSize:7.5,color:ti.c,background:ti.tag,padding:"1px 3px",borderRadius:2,textAlign:"center"}}>{ti.l}</span>
                      <span style={{fontFamily:mono,fontSize:8.5,color:"#888",textAlign:"center"}}>{mh}h</span>
                      <span style={{fontFamily:mono,fontSize:8.5,color:"#333",textAlign:"right",fontWeight:600}}>EGP {(mh*RATE).toLocaleString()}</span>
                    </div>;
                  })}
                </div>;
              })}
            </div>;
          })}
          <div style={{background:"#333",borderRadius:8,padding:"12px 16px",display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
            <div><span style={{fontFamily:disp,fontSize:13,fontWeight:700,color:"#fff"}}>Operations Total (3 months)</span>
              <div style={{fontFamily:mono,fontSize:9,color:"#999"}}>{opsTasks.reduce((s,t)=>s+t.hrs,0)} total hours</div></div>
            <div style={{textAlign:"right"}}>
              <span style={{fontFamily:disp,fontSize:22,fontWeight:800,color:"#D4863A"}}>EGP {opsTotal.toLocaleString()}</span>
              <div style={{fontFamily:mono,fontSize:8.5,color:"#999"}}>~${Math.round(opsTotal/FX).toLocaleString()} USD</div>
            </div>
          </div>

          <div style={{fontFamily:disp,fontSize:14,fontWeight:700,color:"#222",marginBottom:8}}>ðŸ¤ Deal Negotiations (Separate Track)</div>
          {dealMonthly.filter(m=>m.hrs>0).map((m,mi)=>{
            const sorted=m.tasks.slice().sort(prioSort);
            const groups=[{key:"rev",tasks:sorted.filter(t=>t.prio==="rev")},{key:"cost",tasks:sorted.filter(t=>t.prio==="cost")},{key:"cash",tasks:sorted.filter(t=>t.prio==="cash")}].filter(g=>g.tasks.length>0);
            return <div key={mi} style={{background:"#fff",border:"1px solid "+D.deals.bdr,borderRadius:10,padding:"14px 16px",marginBottom:8}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                <div><div style={{fontFamily:disp,fontSize:15,fontWeight:700}}>{m.label}</div><div style={{fontFamily:mono,fontSize:9.5,color:"#aaa"}}>{m.wks}</div></div>
                <div style={{textAlign:"right"}}>
                  <div style={{fontFamily:disp,fontSize:24,fontWeight:800}}>EGP {m.retainer.toLocaleString()}</div>
                  <div style={{fontFamily:mono,fontSize:9,color:m.isFloor?"#D4863A":"#bbb"}}>{m.hrs}h Ã— EGP {RATE.toLocaleString()} = EGP {m.computed.toLocaleString()}{m.isFloor?" â†’ min retainer":""}</div>
                </div>
              </div>
              {groups.map(g=>{const pr=PRIO[g.key];const grpHrs=g.tasks.reduce((s,t)=>s+t.hrs,0);return(
                <div key={g.key} style={{marginBottom:5}}>
                  <div style={{display:"grid",gridTemplateColumns:"20px 1fr 42px 70px",gap:4,alignItems:"center",padding:"3px 6px",background:pr.bg,borderRadius:4,marginBottom:2,border:"1px solid "+pr.bdr}}>
                    <span style={{fontSize:10,textAlign:"center"}}>{pr.ico}</span>
                    <span style={{fontFamily:mono,fontSize:8,color:pr.c,fontWeight:700}}>{pr.l.toUpperCase()}</span>
                    <span style={{fontFamily:mono,fontSize:8,color:pr.c,textAlign:"center"}}>{grpHrs}h</span>
                    <span style={{fontFamily:mono,fontSize:8,color:pr.c,textAlign:"right",fontWeight:700}}>EGP {(grpHrs*RATE).toLocaleString()}</span>
                  </div>
                  {g.tasks.map(t=>(
                    <div key={t.id} style={{display:"grid",gridTemplateColumns:"20px 1fr 42px 70px",gap:4,alignItems:"center",padding:"3px 6px",background:"#fafaf8",borderRadius:3,marginBottom:1,borderLeft:"2px solid "+pr.c+"30"}}>
                      <span style={{fontFamily:mono,fontSize:8,color:"#ccc",textAlign:"right"}}>{t.id}</span>
                      <span style={{fontSize:10,color:"#555"}}>{t.name}</span>
                      <span style={{fontFamily:mono,fontSize:8.5,color:"#888",textAlign:"center"}}>{t.hrs}h</span>
                      <span style={{fontFamily:mono,fontSize:8.5,color:"#333",textAlign:"right",fontWeight:600}}>EGP {(t.hrs*RATE).toLocaleString()}</span>
                    </div>
                  ))}
                </div>
              );})}
            </div>;
          })}
          <div style={{background:D.deals.c,borderRadius:8,padding:"12px 16px",display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
            <span style={{fontFamily:disp,fontSize:13,fontWeight:700,color:"#fff"}}>Deal Negotiations Total (2 months)</span>
            <span style={{fontFamily:disp,fontSize:22,fontWeight:800,color:"#fff"}}>EGP {dealTotal.toLocaleString()}</span>
          </div>
          <div style={{background:"#1a1a1a",borderRadius:10,padding:"18px 20px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <div>
              <div style={{fontFamily:disp,fontSize:16,fontWeight:700,color:"#fff"}}>Total Base Engagement</div>
              <div style={{fontFamily:mono,fontSize:9.5,color:"#666"}}>Ops (3 mo) + Deals (2 mo) + Success Fees on milestones</div>
            </div>
            <div style={{textAlign:"right"}}>
              <div style={{fontFamily:disp,fontSize:30,fontWeight:800,color:"#D4863A"}}>EGP {grandTotal.toLocaleString()}</div>
              <div style={{fontFamily:mono,fontSize:9,color:"#666"}}>~${Math.round(grandTotal/FX).toLocaleString()} USD</div>
            </div>
          </div>
        </div>}

        {/* â•â•â• SUCCESS FEES â•â•â• */}
        {view==="success"&&<div>
          <div style={{background:"#fff",border:"1px solid #fecaca",borderLeft:"4px solid #dc2626",borderRadius:8,padding:"14px 16px",marginBottom:14}}>
            <div style={{fontFamily:disp,fontSize:14,fontWeight:700,color:"#dc2626",marginBottom:4}}>Context: EGP 120M Revenue Â· Negative EBITDA</div>
            <div style={{fontSize:11.5,color:"#555",lineHeight:1.6}}>Each milestone is a verified, measurable step from negative profitability to healthy EBITDA. CÂ² only earns success fees when Abou Shakra achieves real, audited profit improvement.</div>
          </div>
          {milestoneFees.map(m=>{const isOpen=expFee===m.id;
            return <div key={m.id} onClick={()=>setExpFee(isOpen?null:m.id)} style={{background:"#fff",border:isOpen?"1.5px solid "+m.color+"40":"1px solid #e5e1dc",borderRadius:8,padding:"12px 14px",marginBottom:4,cursor:"pointer"}}>
              <div style={{display:"grid",gridTemplateColumns:"28px 1fr 120px",gap:8,alignItems:"center"}}>
                <span style={{fontSize:18,textAlign:"center"}}>{m.icon}</span>
                <div><div style={{fontSize:12.5,fontWeight:700,color:"#222"}}>{m.milestone}</div>
                  <div style={{fontFamily:mono,fontSize:9.5,color:"#999",marginTop:1}}>Saving: {m.saving}</div></div>
                <div style={{textAlign:"center"}}>
                  <div style={{fontFamily:disp,fontSize:18,fontWeight:800,color:m.color}}>{m.feeLabel}</div>
                  <div style={{fontFamily:mono,fontSize:7.5,color:"#bbb"}}>success fee</div>
                </div>
              </div>
              {isOpen&&<div style={{marginTop:8,paddingTop:8,borderTop:"1px solid #eee",display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:6}} onClick={e=>e.stopPropagation()}>
                <div style={{background:"#fafaf8",borderRadius:6,padding:"8px 10px",border:"1px solid #eee"}}>
                  <div style={{fontFamily:mono,fontSize:8,color:"#999",marginBottom:2}}>CURRENT</div>
                  <div style={{fontSize:11,color:"#555"}}>{m.current}</div>
                </div>
                <div style={{background:"#f0fdf4",borderRadius:6,padding:"8px 10px",border:"1px solid #bbf7d0"}}>
                  <div style={{fontFamily:mono,fontSize:8,color:"#16653a",marginBottom:2}}>TARGET</div>
                  <div style={{fontSize:11,color:"#16653a",fontWeight:600}}>{m.target}</div>
                </div>
                <div style={{background:"#eff6ff",borderRadius:6,padding:"8px 10px",border:"1px solid #dbeafe"}}>
                  <div style={{fontFamily:mono,fontSize:8,color:"#1e40af",marginBottom:2}}>VERIFICATION</div>
                  <div style={{fontSize:10.5,color:"#1e40af",lineHeight:1.5}}>{m.how}</div>
                </div>
              </div>}
            </div>;
          })}
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:6,marginTop:10}}>
            <div style={{background:"#f0fdf4",border:"1px solid #bbf7d0",borderRadius:8,padding:"12px 14px",textAlign:"center"}}>
              <div style={{fontFamily:mono,fontSize:8,color:"#16653a"}}>ABOU SHAKRA GAINS</div>
              <div style={{fontFamily:disp,fontSize:24,fontWeight:800,color:"#16653a"}}>EGP 12M+</div>
              <div style={{fontFamily:mono,fontSize:9,color:"#888"}}>annual profit at 10% EBITDA</div>
            </div>
            <div style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:8,padding:"12px 14px",textAlign:"center"}}>
              <div style={{fontFamily:mono,fontSize:8,color:"#999"}}>CÂ² EARNS (MAX)</div>
              <div style={{fontFamily:disp,fontSize:24,fontWeight:800,color:"#D4863A"}}>EGP 1.75M</div>
              <div style={{fontFamily:mono,fontSize:9,color:"#888"}}>all milestones achieved</div>
            </div>
            <div style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:8,padding:"12px 14px",textAlign:"center"}}>
              <div style={{fontFamily:mono,fontSize:8,color:"#999"}}>CLIENT ROI</div>
              <div style={{fontFamily:disp,fontSize:24,fontWeight:800,color:"#7c3aed"}}>{Math.round(12000000/(grandTotal+1750000))}:1</div>
              <div style={{fontFamily:mono,fontSize:9,color:"#888"}}>return on total cost</div>
            </div>
          </div>
        </div>}

        {/* â•â•â• MARKET â•â•â• */}
        {view==="market"&&<div>
          {marketComp.map((m,i)=>{const isUs=m.provider.startsWith("CÂ²");
            return <div key={i} style={{background:isUs?"#f0fdf4":"#fff",border:isUs?"1.5px solid #bbf7d0":"1px solid #e5e1dc",borderRadius:8,padding:"12px 14px",marginBottom:5}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:6}}>
                <div><div style={{fontSize:13,fontWeight:700,color:isUs?"#16653a":"#222"}}>{isUs?"âœ… ":""}{m.provider}</div></div>
                <div style={{textAlign:"right"}}><div style={{fontFamily:disp,fontSize:14,fontWeight:800,color:isUs?"#16653a":"#333"}}>{m.monthly}/mo</div>
                  <div style={{fontFamily:mono,fontSize:8.5,color:"#bbb"}}>Total: {m.total}</div></div>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 70px",gap:6}}>
                <div style={{background:"#fafaf8",borderRadius:5,padding:"6px 8px",border:"1px solid #eee"}}>
                  <div style={{fontFamily:mono,fontSize:7.5,color:"#999"}}>SUCCESS FEE</div>
                  <div style={{fontSize:10.5,color:"#555",marginTop:2}}>{m.success}</div>
                </div>
                <div style={{background:isUs?"#dcfce7":"#fafaf8",borderRadius:5,padding:"6px 8px",border:isUs?"1px solid #bbf7d0":"1px solid #eee"}}>
                  <div style={{fontFamily:mono,fontSize:7.5,color:isUs?"#16653a":"#999"}}>VERDICT</div>
                  <div style={{fontSize:10.5,color:isUs?"#16653a":"#555",fontWeight:isUs?600:400,marginTop:2}}>{m.verdict}</div>
                </div>
                <div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:isUs?"#dcfce7":"#fafaf8",borderRadius:5,border:isUs?"1px solid #bbf7d0":"1px solid #eee",padding:8}}>
                  <div style={{fontFamily:mono,fontSize:7.5,color:"#999"}}>FIT</div>
                  <div style={{display:"flex",gap:2,marginTop:2}}>{[1,2,3,4,5].map(j=><div key={j} style={{width:5,height:5,borderRadius:"50%",background:j<=m.score?isUs?"#16653a":"#D4863A":"#ddd"}}/>)}</div>
                </div>
              </div>
            </div>;
          })}
        </div>}

        {/* â•â•â• BUDGET VS ACTUAL â•â•â• */}
        {view==="budget"&&<div>
          <div style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:8,padding:"14px 16px",marginBottom:12}}>
            <div style={{fontFamily:disp,fontSize:14,fontWeight:700,marginBottom:6}}>ðŸ“Š Forecast P&L vs. Actual â€” Per Branch</div>
            <div style={{fontSize:11.5,color:"#666",lineHeight:1.6,marginBottom:12}}>Enter forecast and actual figures for each branch and month. All values in EGP. EBITDA = Revenue âˆ’ Food Cost âˆ’ Labour Cost. Variances update automatically.</div>

            {/* Add row controls */}
            <div style={{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",marginBottom:8}}>
              <select value={budgetBranch} onChange={e=>setBudgetBranch(e.target.value)} style={{padding:"6px 10px",border:"1px solid #ddd",borderRadius:6,fontSize:11,fontFamily:sans,background:"#fafaf8"}}>
                {BRANCHES.map(b=><option key={b} value={b}>{b}</option>)}
              </select>
              <select value={budgetMonth} onChange={e=>setBudgetMonth(e.target.value)} style={{padding:"6px 10px",border:"1px solid #ddd",borderRadius:6,fontSize:11,fontFamily:sans,background:"#fafaf8"}}>
                {MONTHS_LIST.map(m=><option key={m} value={m}>{m}</option>)}
              </select>
              <button onClick={addBudgetRow} style={{padding:"6px 14px",background:"#1e40af",color:"#fff",border:"none",borderRadius:6,fontSize:11,fontWeight:700,fontFamily:sans}}>+ Add Row</button>
            </div>

            {/* Data entry table */}
            {budgetData.length===0?<div style={{textAlign:"center",padding:"30px",color:"#aaa",fontFamily:mono,fontSize:11}}>No data yet. Select a branch and month above, then click + Add Row.</div>:(
              <div style={{overflowX:"auto"}}>
                <table style={{width:"100%",borderCollapse:"collapse",fontSize:11}}>
                  <thead>
                    <tr style={{background:"#f5f3f0"}}>
                      {["Branch","Month","Rev Forecast","Rev Actual","Rev Var","FC Forecast","FC Actual","FC Var","Lab Forecast","Lab Actual","Lab Var","EBITDA F","EBITDA A","EBITDA Var",""].map((h,i)=>(
                        <th key={i} style={{padding:"6px 8px",fontFamily:mono,fontSize:8,color:"#666",letterSpacing:0.5,textAlign:i>=2?"right":"left",borderBottom:"2px solid #e5e1dc",whiteSpace:"nowrap"}}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {budgetData.map(row=>{
                      const revVar=(Number(row.revA)||0)-(Number(row.revF)||0);
                      const fcVar=(Number(row.fcA)||0)-(Number(row.fcF)||0);
                      const labVar=(Number(row.labA)||0)-(Number(row.labF)||0);
                      const ebitdaF=(Number(row.revF)||0)-(Number(row.fcF)||0)-(Number(row.labF)||0);
                      const ebitdaA=(Number(row.revA)||0)-(Number(row.fcA)||0)-(Number(row.labA)||0);
                      const ebitdaVar=ebitdaA-ebitdaF;
                      const varCell=(v,invert=false)=>{
                        const good=invert?v<0:v>0;
                        const c=v===0?"#888":good?"#16653a":"#dc2626";
                        return <td style={{padding:"5px 8px",fontFamily:mono,fontSize:10,textAlign:"right",color:c,fontWeight:600}}>{v===0?"-":(v>0?"+":"")+v.toLocaleString()}</td>;
                      };
                      const editInput=(field)=><input type="number" value={row[field]} onChange={e=>updateBudget(row.id,field,e.target.value)} style={{width:80,padding:"3px 5px",border:"1px solid #ddd",borderRadius:3,fontSize:10,fontFamily:mono,textAlign:"right",background:"#fafaf8"}}/>;
                      return <tr key={row.id} style={{borderBottom:"1px solid #f0f0ee"}}>
                        <td style={{padding:"5px 8px",fontWeight:600,fontSize:11}}>{row.branch}</td>
                        <td style={{padding:"5px 8px",fontFamily:mono,fontSize:10,color:"#666"}}>{row.month}</td>
                        <td style={{padding:"5px 8px",textAlign:"right"}}>{editInput("revF")}</td>
                        <td style={{padding:"5px 8px",textAlign:"right"}}>{editInput("revA")}</td>
                        {varCell(revVar)}
                        <td style={{padding:"5px 8px",textAlign:"right"}}>{editInput("fcF")}</td>
                        <td style={{padding:"5px 8px",textAlign:"right"}}>{editInput("fcA")}</td>
                        {varCell(fcVar,true)}
                        <td style={{padding:"5px 8px",textAlign:"right"}}>{editInput("labF")}</td>
                        <td style={{padding:"5px 8px",textAlign:"right"}}>{editInput("labA")}</td>
                        {varCell(labVar,true)}
                        <td style={{padding:"5px 8px",fontFamily:mono,fontSize:10,textAlign:"right",color:"#1e40af"}}>{ebitdaF.toLocaleString()}</td>
                        <td style={{padding:"5px 8px",fontFamily:mono,fontSize:10,textAlign:"right",color:"#1e40af",fontWeight:600}}>{ebitdaA.toLocaleString()}</td>
                        {varCell(ebitdaVar)}
                        <td style={{padding:"5px 8px"}}><button onClick={()=>deleteBudgetRow(row.id)} style={{background:"#fee2e2",border:"none",borderRadius:3,padding:"2px 6px",fontSize:9,color:"#dc2626",cursor:"pointer",fontFamily:mono}}>âœ•</button></td>
                      </tr>;
                    })}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {/* Branch summary cards */}
          {budgetData.length>0&&<div>
            <div style={{fontFamily:mono,fontSize:8,color:"#999",letterSpacing:1.5,marginBottom:8}}>BRANCH SUMMARY (ALL MONTHS COMBINED)</div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(220px,1fr))",gap:8}}>
              {BRANCHES.filter(b=>budgetSummary[b]?.count>0).map(b=>{
                const s=budgetSummary[b];
                const ebitdaF=s.revF-s.fcF-s.labF, ebitdaA=s.revA-s.fcA-s.labA;
                const ebitdaVar=ebitdaA-ebitdaF;
                const pct=s.revA>0?((ebitdaA/s.revA)*100).toFixed(1):"â€”";
                const col=ebitdaA>0?"#16653a":ebitdaA<0?"#dc2626":"#888";
                return <div key={b} style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:8,padding:"12px 14px",borderLeft:"4px solid "+col}}>
                  <div style={{fontFamily:disp,fontSize:13,fontWeight:700,marginBottom:4}}>{b}</div>
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:4}}>
                    <div>
                      <div style={{fontFamily:mono,fontSize:7.5,color:"#aaa"}}>REV ACTUAL</div>
                      <div style={{fontFamily:mono,fontSize:10,fontWeight:600}}>{s.revA.toLocaleString()}</div>
                    </div>
                    <div>
                      <div style={{fontFamily:mono,fontSize:7.5,color:"#aaa"}}>EBITDA</div>
                      <div style={{fontFamily:mono,fontSize:10,fontWeight:600,color:col}}>{ebitdaA.toLocaleString()} ({pct}%)</div>
                    </div>
                    <div>
                      <div style={{fontFamily:mono,fontSize:7.5,color:"#aaa"}}>FOOD COST</div>
                      <div style={{fontFamily:mono,fontSize:10,color:s.fcA>s.fcF?"#dc2626":"#16653a"}}>{s.fcA.toLocaleString()}</div>
                    </div>
                    <div>
                      <div style={{fontFamily:mono,fontSize:7.5,color:"#aaa"}}>EBITDA VAR</div>
                      <div style={{fontFamily:mono,fontSize:10,fontWeight:600,color:ebitdaVar>0?"#16653a":ebitdaVar<0?"#dc2626":"#888"}}>{ebitdaVar>0?"+":""}{ebitdaVar.toLocaleString()}</div>
                    </div>
                  </div>
                  <div style={{fontFamily:mono,fontSize:7.5,color:"#bbb",marginTop:6}}>{s.count} month{s.count>1?"s":""} of data</div>
                </div>;
              })}
            </div>

            {/* Total bar */}
            <div style={{marginTop:12,background:"#1a1a1a",borderRadius:8,padding:"14px 16px",display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:10}}>
              {budgetTotals.map((s,i)=><div key={i}><div style={{fontFamily:mono,fontSize:7.5,color:"#666",letterSpacing:1}}>{s.l}</div><div style={{fontFamily:disp,fontSize:18,fontWeight:800,color:s.c}}>{s.v}</div></div>)}
            </div>
          </div>}
        </div>}

        {/* â•â•â• COMMENTS & TASKS â•â•â• */}
        {view==="notes"&&<div>
          <div style={{display:"flex",gap:8,marginBottom:12,flexWrap:"wrap",alignItems:"center"}}>
            <div>
              <div style={{fontFamily:disp,fontSize:14,fontWeight:700,color:"#222"}}>Comments & Action Items</div>
              <div style={{fontFamily:mono,fontSize:9,color:"#aaa"}}>{comments.length} entries Â· {comments.filter(c=>c.status==="Open").length} open</div>
            </div>
            <div style={{flex:1}}/>
            <select value={commentFilter} onChange={e=>setCommentFilter(e.target.value)} style={{padding:"5px 9px",border:"1px solid #ddd",borderRadius:5,fontSize:10,fontFamily:sans}}>
              <option value="all">All types</option>
              <option value="comment">Comments only</option>
              <option value="action">Action items only</option>
              <option value="risk">Risks only</option>
              <option value="decision">Decisions only</option>
            </select>
            <button onClick={()=>setShowAddComment(true)} style={{padding:"7px 13px",background:"#1e40af",color:"#fff",border:"none",borderRadius:6,fontSize:11,fontWeight:700,fontFamily:sans}}>+ Add Comment</button>
            <button onClick={()=>setShowAddTask(true)} style={{padding:"7px 13px",background:"#16653a",color:"#fff",border:"none",borderRadius:6,fontSize:11,fontWeight:700,fontFamily:sans}}>+ Add Task</button>
          </div>

          {comments.length===0?<div style={{textAlign:"center",padding:"40px",color:"#aaa",fontFamily:mono,fontSize:11,background:"#fff",borderRadius:8,border:"1px dashed #ddd"}}>No comments yet. Add your first comment or action item above.</div>
          :(comments.filter(c=>commentFilter==="all"||c.type===commentFilter).map(c=>{
            const typeConfig={comment:{ico:"ðŸ’¬",c:"#1e40af",bg:"#eff6ff",bdr:"#bfdbfe"},action:{ico:"âœ…",c:"#16653a",bg:"#f0fdf4",bdr:"#bbf7d0"},risk:{ico:"âš ï¸",c:"#dc2626",bg:"#fef2f2",bdr:"#fecaca"},decision:{ico:"ðŸŽ¯",c:"#7c3aed",bg:"#faf5ff",bdr:"#ddd6fe"}}[c.type]||{ico:"ðŸ’¬",c:"#666",bg:"#fafaf8",bdr:"#e5e1dc"};
            const isOpen=c.status==="Open";
            return <div key={c.id} style={{background:typeConfig.bg,border:"1px solid "+typeConfig.bdr,borderRadius:8,padding:"10px 14px",marginBottom:6,borderLeft:"3px solid "+typeConfig.c,opacity:isOpen?1:0.7}}>
              <div style={{display:"flex",gap:8,alignItems:"flex-start"}}>
                <span style={{fontSize:14,flexShrink:0}}>{typeConfig.ico}</span>
                <div style={{flex:1,minWidth:0}}>
                  <div style={{display:"flex",gap:6,alignItems:"center",marginBottom:3,flexWrap:"wrap"}}>
                    <span style={{fontFamily:mono,fontSize:9,color:typeConfig.c,background:"#fff",padding:"1px 5px",borderRadius:3,fontWeight:700,textTransform:"uppercase"}}>{c.type}</span>
                    {c.task&&<span style={{fontFamily:mono,fontSize:8.5,color:"#888"}}>re: {c.task}</span>}
                    <span style={{fontFamily:mono,fontSize:8,color:"#bbb",marginLeft:"auto"}}>{c.author} Â· {c.date}</span>
                  </div>
                  <div style={{fontSize:11.5,color:"#333",lineHeight:1.6}}>{c.content}</div>
                </div>
                <div style={{display:"flex",gap:4,flexShrink:0}}>
                  <button onClick={()=>toggleCommentStatus(c.id)} style={{padding:"3px 7px",background:isOpen?"#fef9c3":"#dcfce7",border:"none",borderRadius:4,fontSize:8.5,fontFamily:mono,color:isOpen?"#a16207":"#16653a",cursor:"pointer",fontWeight:700}}>{isOpen?"Resolve":"Reopen"}</button>
                  <button onClick={()=>deleteComment(c.id)} style={{padding:"3px 6px",background:"#fee2e2",border:"none",borderRadius:4,fontSize:8.5,fontFamily:mono,color:"#dc2626",cursor:"pointer"}}>âœ•</button>
                </div>
              </div>
            </div>;
          }))}

          {/* Custom tasks section */}
          {tasks.filter(t=>t.id>100).length>0&&<div style={{marginTop:16}}>
            <div style={{fontFamily:mono,fontSize:8,color:"#999",letterSpacing:1.5,marginBottom:8}}>CUSTOM TASKS ADDED</div>
            {tasks.filter(t=>t.id>100).map(t=><TaskCard key={t.id} t={t}/>)}
          </div>}
        </div>}


            {view==="mktplan"&&(()=>{
          // â”€â”€â”€ COMPUTED GLOBALS â”€â”€â”€
          const P=mktPlan.pricing;
          const nights=Number(P.ramadanNights)||30;
          const avgIftar=Number(P.avgCheckIftar)||340;
          const avgSuhoor=Number(P.avgCheckSuhoor)||280;
          const avgDel=Number(P.avgCheckDelivery)||185;
          const iftarCov=Number(P.iftarCoversPerNight)||320;
          const suhoorCov=Number(P.suhoorCoversPerNight)||140;
          const delOrd=Number(P.deliveryOrdersPerMonth)||680;
          const repRate=Number(P.repeatRate)||45;

          // B2C channel aggregates
          const active=Object.entries(mktPlan.channels).filter(([,c])=>c.active);
          const chColors={social:"#be185d",google:"#1e40af",influencer:"#a16207",talabat:"#16653a",crm:"#7c3aed",gmb:"#0f766e",corporate:"#d97706"};
          const totalB2CBudget=active.reduce((s,[,c])=>s+(Number(c.budget)||0),0);
          const totalImp=active.reduce((s,[,c])=>s+(Number(c.impressions)||0),0);
          const totalClicks=active.reduce((s,[,c])=>s+(Number(c.clicks)||0),0);
          const totalB2COrders=active.reduce((s,[,c])=>s+(Number(c.orders)||0),0);

          // Per-channel CAC & conversion
          const chMetrics=active.map(([k,c])=>{
            const imp=Number(c.impressions)||0;
            const clicks=Number(c.clicks)||0;
            const orders=Number(c.orders)||0;
            const budget=Number(c.budget)||0;
            const ctr=imp>0?(clicks/imp*100):0;
            const cvr=clicks>0?(orders/clicks*100):0;
            const cac=orders>0&&budget>0?Math.round(budget/orders):null;
            const avgSpend=orders>0?(orders*avgIftar):0; // revenue this channel drove
            const roas=budget>0&&avgSpend>0?(avgSpend/budget):null;
            return {k,c,imp,clicks,orders,budget,ctr,cvr,cac,roas,color:chColors[k]||"#888",name:c.name.split("â€”")[0].trim()};
          });
          const blendedCAC=totalB2COrders>0&&totalB2CBudget>0?Math.round(totalB2CBudget/totalB2COrders):0;

          // B2B pipeline
          const B=mktPlan.b2b;
          const b2bActive=B.active;
          const pipeline=Number(B.pipelineClients)||12;
          const closeRate=Number(B.closeRate)||40;
          const groupSize=Number(B.avgGroupSize)||25;
          const pkgPrice=Number(B.avgPackagePrice)||280;
          const bookings=Number(B.bookingsPerClient)||2;
          const b2bBudget=Number(B.salesBudget)||8000;
          const b2bWonClients=Math.round(pipeline*(closeRate/100));
          const b2bCovers=b2bWonClients*groupSize*bookings;
          const b2bRevenue=b2bCovers*pkgPrice;
          const b2bCAC=b2bWonClients>0?Math.round(b2bBudget/b2bWonClients):0;
          const b2bCoverCAC=b2bCovers>0?Math.round(b2bBudget/b2bCovers):0;

          // Revenue totals
          const b2cRevPerBranch=iftarCov*nights*avgIftar + suhoorCov*nights*avgSuhoor + delOrd*avgDel;
          const b2cRev8=b2cRevPerBranch*8;
          const totalRev8=b2cRev8+(b2bActive?b2bRevenue*8:0);
          const totalBudget=totalB2CBudget+(b2bActive?b2bBudget:0);
          const totalBudget8=totalBudget*8;
          const overallROI=totalBudget8>0?((totalRev8-totalBudget8)/totalBudget8).toFixed(1):0;

          // Funnel
          const fStages=[
            {label:"Impressions",val:totalImp,color:"#1e40af",icon:"ðŸ‘",pct:100},
            {label:"Clicks / Reach",val:totalClicks,color:"#a16207",icon:"ðŸ”",pct:totalImp>0?(totalClicks/totalImp*100):0},
            {label:"Orders / Covers",val:totalB2COrders,color:"#16653a",icon:"ðŸ›’",pct:totalImp>0?(totalB2COrders/totalImp*100):0},
            {label:"Repeat Customers",val:Math.round(totalB2COrders*(repRate/100)),color:"#be185d",icon:"ðŸ”„",pct:totalImp>0?(Math.round(totalB2COrders*(repRate/100))/totalImp*100):0},
          ];
          const topFVal=Math.max(...fStages.map(s=>s.val),1);

          return(
          <div>

            {/* â”€â”€ HEADER â”€â”€ */}
            <div style={{background:"linear-gradient(135deg,#0d0d1a,#1a0a2e 50%,#2d1b4e)",borderRadius:12,padding:"20px 22px",marginBottom:12,position:"relative",overflow:"hidden"}}>
              <div style={{position:"absolute",top:-10,right:10,fontSize:70,opacity:0.06}}>{"ðŸŒ™"}</div>
              <div style={{fontFamily:mono,fontSize:8,color:"rgba(212,175,55,0.6)",letterSpacing:3,marginBottom:4}}>RAMADAN 1446 Â· ABOU SHAKRA Â· 8 BRANCHES Â· B2C + B2B</div>
              <div style={{fontFamily:disp,fontSize:22,fontWeight:800,color:"#f5e6a3",marginBottom:12}}>{"Ø±Ù…Ø¶Ø§Ù†"} Marketing & Sales Plan</div>
              <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
                {[
                  {l:"Total Campaign Budget",v:`EGP ${totalBudget.toLocaleString()}`,sub:`EGP ${totalBudget8.toLocaleString()} Ã— 8 branches`,gold:true},
                  {l:"B2C Blended CAC",v:blendedCAC>0?`EGP ${blendedCAC}`:"â€”",sub:`${totalB2COrders.toLocaleString()} orders from paid`},
                  {l:"B2B Pipeline",v:`${pipeline} clients`,sub:`${b2bWonClients} expected to close (${closeRate}%)`},
                  {l:"B2B Revenue / Branch",v:`EGP ${b2bRevenue.toLocaleString()}`,sub:`${b2bCovers.toLocaleString()} covers Ã— EGP ${pkgPrice}`},
                  {l:"Projected Group Revenue",v:`EGP ${Math.round(totalRev8/1000)}K`,sub:`B2C + B2B Â· 8 branches`},
                  {l:"Overall Marketing ROI",v:`${overallROI}Ã—`,sub:"(revenue âˆ’ spend) / spend",hi:Number(overallROI)>=5},
                ].map((s,i)=>(
                  <div key={i} style={{background:s.gold?"rgba(212,175,55,0.15)":s.hi?"rgba(22,101,58,0.25)":"rgba(255,255,255,0.07)",border:s.gold?"1px solid rgba(212,175,55,0.3)":"1px solid rgba(255,255,255,0.1)",borderRadius:8,padding:"10px 14px",minWidth:130}}>
                    <div style={{fontFamily:mono,fontSize:7,color:s.gold?"rgba(212,175,55,0.7)":"rgba(255,255,255,0.4)",letterSpacing:1,marginBottom:3}}>{s.l.toUpperCase()}</div>
                    <div style={{fontFamily:disp,fontSize:17,fontWeight:800,color:s.gold?"#f5e6a3":"#fff"}}>{s.v}</div>
                    <div style={{fontFamily:mono,fontSize:7.5,color:"rgba(255,255,255,0.3)",marginTop:2}}>{s.sub}</div>
                  </div>
                ))}
              </div>
            </div>

            {/* â”€â”€ SECTION 1: BUDGET ALLOCATION â”€â”€ */}
            <div style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:10,padding:"16px",marginBottom:12}}>
              <div style={{fontFamily:disp,fontSize:14,fontWeight:700,color:"#222",marginBottom:2}}>ðŸ’° Total Budget Allocation</div>
              <div style={{fontFamily:mono,fontSize:8.5,color:"#999",marginBottom:12}}>Set budget per channel â€” CAC, conversion rate, and ROAS calculate automatically from your actuals below</div>

              {/* Budget bar */}
              {(()=>{
                const allChs=[...active,...(b2bActive?[["b2b_corp",{name:"B2B Corporate",budget:b2bBudget,color:"#d97706"}]]:[])]
                const tot=allChs.reduce((s,[,c])=>s+(Number(c.budget)||0),0)||1;
                const colors=[...active.map(([k])=>chColors[k]||"#888"),"#d97706"];
                return(<div style={{marginBottom:12}}>
                  <div style={{display:"flex",height:12,borderRadius:6,overflow:"hidden",marginBottom:6}}>
                    {allChs.map(([k,c],i)=>(
                      <div key={k} title={c.name} style={{width:`${(Number(c.budget)||0)/tot*100}%`,background:colors[i],transition:"width 0.3s"}}/>
                    ))}
                  </div>
                  <div style={{display:"flex",gap:10,flexWrap:"wrap"}}>
                    {allChs.map(([k,c],i)=>(
                      <div key={k} style={{display:"flex",alignItems:"center",gap:4}}>
                        <div style={{width:8,height:8,borderRadius:2,background:colors[i]}}/>
                        <span style={{fontFamily:mono,fontSize:7.5,color:"#777"}}>{(c.name||"").split("â€”")[0].trim()} Â· {Math.round((Number(c.budget)||0)/tot*100)}% Â· EGP {Number(c.budget||0).toLocaleString()}</span>
                      </div>
                    ))}
                  </div>
                </div>);
              })()}

              {/* Budget summary cards */}
              <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:8,marginBottom:12}}>
                {[
                  {l:"B2C Digital & Organic",v:`EGP ${totalB2CBudget.toLocaleString()}`,sub:`${active.length} channels`,c:"#1e40af"},
                  {l:"B2B Corporate Sales",v:`EGP ${b2bActive?b2bBudget.toLocaleString():"0"}`,sub:"outreach + events",c:"#d97706"},
                  {l:"Total Per Branch",v:`EGP ${totalBudget.toLocaleString()}`,sub:`EGP ${totalBudget8.toLocaleString()} group total`,c:"#be185d",bold:true},
                ].map((s,i)=>(
                  <div key={i} style={{background:"#f9f8f6",borderRadius:8,padding:"12px",borderLeft:`3px solid ${s.c}`}}>
                    <div style={{fontFamily:mono,fontSize:7.5,color:"#999",marginBottom:4}}>{s.l.toUpperCase()}</div>
                    <div style={{fontFamily:disp,fontSize:18,fontWeight:800,color:s.c}}>{s.v}</div>
                    <div style={{fontFamily:mono,fontSize:8,color:"#bbb"}}>{s.sub}</div>
                  </div>
                ))}
              </div>
            </div>

            {/* â”€â”€ SECTION 2: B2C CHANNEL TABLE â€” wired CAC + conversion â”€â”€ */}
            <div style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:10,padding:"16px",marginBottom:12}}>
              <div style={{fontFamily:disp,fontSize:14,fontWeight:700,color:"#222",marginBottom:2}}>ðŸ“¡ B2C Channels â€” CAC, Conversion & Avg Spend</div>
              <div style={{fontFamily:mono,fontSize:8.5,color:"#999",marginBottom:12}}>CAC = Budget Ã· Orders. CTR = Clicks Ã· Impressions. CVR = Orders Ã· Clicks. Avg Spend = Orders Ã— Avg Check. ROAS = Avg Spend Ã· Budget.</div>
              <div style={{overflowX:"auto"}}>
                <table style={{width:"100%",borderCollapse:"collapse",fontFamily:sans,fontSize:11}}>
                  <thead>
                    <tr style={{background:"#f5f3f0"}}>
                      {["","Channel","Budget","Impressions","Clicks","CTR","Orders","CVR","CAC","Avg Spend Driven","ROAS","Signal"].map((h,i)=>(
                        <th key={i} style={{padding:"6px 8px",textAlign:"left",fontFamily:mono,fontSize:7,color:"#999",letterSpacing:1,borderBottom:"2px solid #e5e1dc",fontWeight:700,whiteSpace:"nowrap"}}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {chMetrics.map((m,i)=>{
                      const roasColor=m.roas>=5?"#16653a":m.roas>=3?"#a16207":m.roas>0?"#dc2626":"#999";
                      const cacColor=m.cac&&m.cac<avgIftar*0.3?"#16653a":m.cac&&m.cac<avgIftar?"#a16207":m.cac?"#dc2626":"#bbb";
                      return(
                        <tr key={m.k} style={{borderBottom:"1px solid #f5f3f0",background:m.c.active?"#fff":"#fafaf8",opacity:m.c.active?1:0.5}}>
                          <td style={{padding:"7px 8px"}}>
                            <div style={{display:"flex",alignItems:"center",gap:5}}>
                              <input type="checkbox" checked={m.c.active} onChange={e=>updMktCh(m.k,"active",e.target.checked)} style={{width:13,height:13,accentColor:m.color,cursor:"pointer"}}/>
                              <div style={{width:3,height:20,borderRadius:1,background:m.c.active?m.color:"#ddd"}}/>
                            </div>
                          </td>
                          <td style={{padding:"7px 8px",fontWeight:600,color:"#222",whiteSpace:"nowrap",maxWidth:160,overflow:"hidden",textOverflow:"ellipsis"}}>{m.name}</td>
                          <td style={{padding:"7px 8px"}}>
                            <input type="number" value={m.c.budget} onChange={e=>updMktCh(m.k,"budget",Number(e.target.value))} disabled={!m.c.active}
                              style={{width:75,padding:"3px 6px",border:`1px solid ${m.color}40`,borderRadius:4,fontFamily:mono,fontSize:10,fontWeight:700,color:m.color,background:m.c.active?"#fff":"#f9f9f9"}}/>
                          </td>
                          <td style={{padding:"7px 8px"}}>
                            <input type="text" value={m.c.impressions} onChange={e=>updMktCh(m.k,"impressions",e.target.value)} placeholder="â€”" disabled={!m.c.active}
                              style={{width:75,padding:"3px 6px",border:"1px solid #e5e1dc",borderRadius:4,fontFamily:mono,fontSize:10,background:m.c.active?"#fff":"#f9f9f9",color:"#333"}}/>
                          </td>
                          <td style={{padding:"7px 8px"}}>
                            <input type="text" value={m.c.clicks} onChange={e=>updMktCh(m.k,"clicks",e.target.value)} placeholder="â€”" disabled={!m.c.active}
                              style={{width:70,padding:"3px 6px",border:"1px solid #e5e1dc",borderRadius:4,fontFamily:mono,fontSize:10,background:m.c.active?"#fff":"#f9f9f9",color:"#333"}}/>
                          </td>
                          <td style={{padding:"7px 8px",fontFamily:mono,fontSize:10,color:m.ctr>5?"#16653a":m.ctr>2?"#a16207":m.imp>0?"#dc2626":"#bbb",fontWeight:m.imp>0?700:400}}>
                            {m.imp>0?`${m.ctr.toFixed(1)}%`:"â€”"}
                          </td>
                          <td style={{padding:"7px 8px"}}>
                            <input type="text" value={m.c.orders} onChange={e=>updMktCh(m.k,"orders",e.target.value)} placeholder="â€”" disabled={!m.c.active}
                              style={{width:65,padding:"3px 6px",border:"1px solid #e5e1dc",borderRadius:4,fontFamily:mono,fontSize:10,background:m.c.active?"#fff":"#f9f9f9",color:"#333"}}/>
                          </td>
                          <td style={{padding:"7px 8px",fontFamily:mono,fontSize:10,color:m.cvr>20?"#16653a":m.cvr>10?"#a16207":m.clicks>0?"#dc2626":"#bbb",fontWeight:m.clicks>0?700:400}}>
                            {m.clicks>0?`${m.cvr.toFixed(1)}%`:"â€”"}
                          </td>
                          <td style={{padding:"7px 8px",fontFamily:mono,fontSize:10,fontWeight:700,color:cacColor}}>
                            {m.cac?`EGP ${m.cac}`:"â€”"}
                          </td>
                          <td style={{padding:"7px 8px",fontFamily:mono,fontSize:10,fontWeight:600,color:"#555"}}>
                            {m.orders>0?`EGP ${(m.orders*avgIftar).toLocaleString()}`:"â€”"}
                          </td>
                          <td style={{padding:"7px 8px",fontFamily:mono,fontSize:10,fontWeight:700,color:roasColor}}>
                            {m.roas?`${m.roas.toFixed(1)}Ã—`:"â€”"}
                          </td>
                          <td style={{padding:"7px 8px"}}>
                            {!m.c.active?<span style={{fontFamily:mono,fontSize:7,color:"#ccc"}}>OFF</span>
                            :m.roas>=5?<span style={{fontFamily:mono,fontSize:7,color:"#16653a",background:"#f0fdf4",padding:"2px 5px",borderRadius:3,fontWeight:700}}>ðŸš€ SCALE</span>
                            :m.roas>=3?<span style={{fontFamily:mono,fontSize:7,color:"#a16207",background:"#fffbeb",padding:"2px 5px",borderRadius:3,fontWeight:700}}>âœ“ HOLD</span>
                            :m.roas>0?<span style={{fontFamily:mono,fontSize:7,color:"#dc2626",background:"#fef2f2",padding:"2px 5px",borderRadius:3,fontWeight:700}}>âš  REVIEW</span>
                            :<span style={{fontFamily:mono,fontSize:7,color:"#bbb",padding:"2px 5px",borderRadius:3}}>NO DATA</span>}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                  <tfoot>
                    <tr style={{background:"#f5f3f0",borderTop:"2px solid #e5e1dc"}}>
                      <td colSpan={2} style={{padding:"7px 8px",fontFamily:mono,fontSize:8,fontWeight:700,color:"#555"}}>TOTALS â€” B2C ACTIVE</td>
                      <td style={{padding:"7px 8px",fontFamily:mono,fontSize:10,fontWeight:800,color:"#be185d"}}>EGP {totalB2CBudget.toLocaleString()}</td>
                      <td style={{padding:"7px 8px",fontFamily:mono,fontSize:10,fontWeight:700,color:"#1e40af"}}>{totalImp.toLocaleString()}</td>
                      <td style={{padding:"7px 8px",fontFamily:mono,fontSize:10,fontWeight:700,color:"#a16207"}}>{totalClicks.toLocaleString()}</td>
                      <td style={{padding:"7px 8px",fontFamily:mono,fontSize:10,fontWeight:700,color:"#555"}}>{totalImp>0?`${(totalClicks/totalImp*100).toFixed(1)}%`:"â€”"}</td>
                      <td style={{padding:"7px 8px",fontFamily:mono,fontSize:10,fontWeight:700,color:"#16653a"}}>{totalB2COrders.toLocaleString()}</td>
                      <td style={{padding:"7px 8px",fontFamily:mono,fontSize:10,fontWeight:700,color:"#555"}}>{totalClicks>0?`${(totalB2COrders/totalClicks*100).toFixed(1)}%`:"â€”"}</td>
                      <td style={{padding:"7px 8px",fontFamily:mono,fontSize:10,fontWeight:800,color:blendedCAC<avgIftar*0.3?"#16653a":"#dc2626"}}>{blendedCAC>0?`EGP ${blendedCAC}`:"â€”"}</td>
                      <td style={{padding:"7px 8px",fontFamily:mono,fontSize:10,fontWeight:700,color:"#555"}}>EGP {(totalB2COrders*avgIftar).toLocaleString()}</td>
                      <td colSpan={2} style={{padding:"7px 8px",fontFamily:mono,fontSize:10,fontWeight:800,color:"#16653a"}}>{totalB2CBudget>0?`${((totalB2COrders*avgIftar)/totalB2CBudget).toFixed(1)}Ã— ROAS`:"â€”"}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>

            {/* â”€â”€ SECTION 3: B2B CORPORATE IFTAR â”€â”€ */}
            <div style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:10,padding:"16px",marginBottom:12}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
                <div>
                  <div style={{fontFamily:disp,fontSize:14,fontWeight:700,color:"#222"}}>ðŸ¢ B2B Corporate Iftar Sales Pipeline</div>
                  <div style={{fontFamily:mono,fontSize:8.5,color:"#999",marginTop:2}}>Corporate Iftar packages â€” bulk bookings, branded setups, fixed per-person pricing</div>
                </div>
                <label style={{display:"flex",alignItems:"center",gap:6,cursor:"pointer"}}>
                  <input type="checkbox" checked={b2bActive} onChange={e=>updMktB2B("active",e.target.checked)} style={{width:14,height:14,accentColor:"#d97706"}}/>
                  <span style={{fontFamily:mono,fontSize:8,color:b2bActive?"#d97706":"#bbb",fontWeight:700}}>{b2bActive?"B2B ACTIVE":"B2B OFF"}</span>
                </label>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(160px,1fr))",gap:10,marginBottom:14,opacity:b2bActive?1:0.4}}>
                {[
                  {l:"Clients in Pipeline",f:"pipelineClients",v:B.pipelineClients,icon:"ðŸ¢",c:"#d97706",desc:"Companies being pitched"},
                  {l:"Expected Close Rate (%)",f:"closeRate",v:B.closeRate,icon:"ðŸ¤",c:"#1e40af",desc:"Industry avg 30â€“50%"},
                  {l:"Avg Group Size (covers)",f:"avgGroupSize",v:B.avgGroupSize,icon:"ðŸª‘",c:"#16653a",desc:"Per corporate booking"},
                  {l:"Package Price (EGP/person)",f:"avgPackagePrice",v:B.avgPackagePrice,icon:"ðŸ’µ",c:"#be185d",desc:"Fixed Iftar package rate"},
                  {l:"Bookings Per Client",f:"bookingsPerClient",v:B.bookingsPerClient,icon:"ðŸ“…",c:"#7c3aed",desc:"Avg repeat over Ramadan"},
                  {l:"B2B Sales Budget (EGP)",f:"salesBudget",v:B.salesBudget,icon:"ðŸ“¢",c:"#dc2626",desc:"Outreach + hosting cost"},
                ].map(({l,f,v,icon,c,desc})=>(
                  <div key={f} style={{background:"#f9f8f6",borderRadius:8,padding:"11px",borderLeft:`3px solid ${c}`}}>
                    <div style={{display:"flex",alignItems:"center",gap:5,marginBottom:5}}>
                      <span style={{fontSize:14}}>{icon}</span>
                      <div style={{fontFamily:mono,fontSize:7,color:"#999",letterSpacing:1,lineHeight:1.3}}>{l.toUpperCase()}</div>
                    </div>
                    <input type="number" value={v} onChange={e=>updMktB2B(f,Number(e.target.value))} disabled={!b2bActive}
                      style={{width:"100%",padding:"4px 7px",border:`1px solid ${c}40`,borderRadius:4,fontFamily:mono,fontSize:14,fontWeight:700,color:c,boxSizing:"border-box",marginBottom:3,background:b2bActive?"#fff":"#f5f5f5"}}/>
                    <div style={{fontFamily:sans,fontSize:8,color:"#bbb"}}>{desc}</div>
                  </div>
                ))}
              </div>
              {/* B2B output */}
              <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:8,background:"#fffbeb",borderRadius:8,padding:"12px",border:"1px solid #fde68a",opacity:b2bActive?1:0.4}}>
                {[
                  {l:"Clients Won",v:b2bWonClients,sub:`${closeRate}% of ${pipeline}`,c:"#d97706"},
                  {l:"Total B2B Covers",v:b2bCovers.toLocaleString(),sub:`${b2bWonClients}Ã—${groupSize}Ã—${bookings} bookings`,c:"#16653a"},
                  {l:"B2B Revenue / Branch",v:`EGP ${b2bRevenue.toLocaleString()}`,sub:`${b2bCovers} covers Ã— EGP ${pkgPrice}`,c:"#be185d",bold:true},
                  {l:"B2B CAC / Client Won",v:b2bCAC>0?`EGP ${b2bCAC}`:"â€”",sub:`EGP ${b2bCoverCAC}/cover`,c:"#1e40af"},
                ].map((s,i)=>(
                  <div key={i} style={{background:"#fff",borderRadius:6,padding:"10px 12px",border:"1px solid #fde68a"}}>
                    <div style={{fontFamily:mono,fontSize:7.5,color:"#999",letterSpacing:1,marginBottom:3}}>{s.l.toUpperCase()}</div>
                    <div style={{fontFamily:disp,fontSize:s.bold?18:16,fontWeight:800,color:s.c}}>{s.v}</div>
                    <div style={{fontFamily:mono,fontSize:7.5,color:"#bbb",marginTop:2}}>{s.sub}</div>
                  </div>
                ))}
              </div>
            </div>

            {/* â”€â”€ SECTION 4: PRICING & AVG SPEND â”€â”€ */}
            <div style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:10,padding:"16px",marginBottom:12}}>
              <div style={{fontFamily:disp,fontSize:14,fontWeight:700,color:"#222",marginBottom:2}}>ðŸ§¾ Avg Cover & Spend Per Customer â€” By Session</div>
              <div style={{fontFamily:mono,fontSize:8.5,color:"#999",marginBottom:12}}>These drive all revenue calculations. Ramadan avg checks are typically 20â€“40% above baseline.</div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(170px,1fr))",gap:10,marginBottom:14}}>
                {[
                  {l:"Iftar Avg Check (EGP)",f:"avgCheckIftar",v:P.avgCheckIftar,icon:"ðŸŒ™",c:"#7c3aed",desc:"Per cover, 7â€“10pm session"},
                  {l:"Suhoor Avg Check (EGP)",f:"avgCheckSuhoor",v:P.avgCheckSuhoor,icon:"â­",c:"#1e40af",desc:"Per cover, 1â€“3am session"},
                  {l:"Delivery Net / Order (EGP)",f:"avgCheckDelivery",v:P.avgCheckDelivery,icon:"ðŸ›µ",c:"#16653a",desc:"After Talabat/Noon commission"},
                  {l:"Iftar Covers / Night",f:"iftarCoversPerNight",v:P.iftarCoversPerNight,icon:"ðŸª‘",c:"#be185d",desc:"Per branch"},
                  {l:"Suhoor Covers / Night",f:"suhoorCoversPerNight",v:P.suhoorCoversPerNight,icon:"ðŸª‘",c:"#a16207",desc:"Per branch"},
                  {l:"Delivery Orders / Month",f:"deliveryOrdersPerMonth",v:P.deliveryOrdersPerMonth,icon:"ðŸ“¦",c:"#0f766e",desc:"Per branch"},
                  {l:"Ramadan Nights",f:"ramadanNights",v:P.ramadanNights,icon:"ðŸ“…",c:"#6b7280",desc:"Campaign duration"},
                  {l:"Repeat Rate Target (%)",f:"repeatRate",v:P.repeatRate,icon:"ðŸ”„",c:"#dc2626",desc:"Customers with 2+ visits"},
                ].map(({l,f,v,icon,c,desc})=>(
                  <div key={f} style={{background:"#f9f8f6",borderRadius:8,padding:"11px",borderLeft:`3px solid ${c}`}}>
                    <div style={{display:"flex",alignItems:"center",gap:5,marginBottom:5}}>
                      <span style={{fontSize:14}}>{icon}</span>
                      <div style={{fontFamily:mono,fontSize:7,color:"#999",letterSpacing:1,lineHeight:1.3}}>{l.toUpperCase()}</div>
                    </div>
                    <input type="number" value={v} onChange={e=>updMktPricing(f,Number(e.target.value))}
                      style={{width:"100%",padding:"4px 7px",border:`1px solid ${c}40`,borderRadius:4,fontFamily:mono,fontSize:14,fontWeight:700,color:c,boxSizing:"border-box",marginBottom:3}}/>
                    <div style={{fontFamily:sans,fontSize:8,color:"#bbb"}}>{desc}</div>
                  </div>
                ))}
              </div>
              {/* Session revenue breakdown */}
              <div style={{background:"#f0fdf4",borderRadius:8,padding:"12px 16px",border:"1px solid #bbf7d0"}}>
                <div style={{fontFamily:mono,fontSize:8,color:"#16653a",letterSpacing:1,marginBottom:8}}>REVENUE PER BRANCH â€” RAMADAN MONTH</div>
                <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(160px,1fr))",gap:8}}>
                  {[
                    {l:"Iftar Total",v:`EGP ${(iftarCov*nights*avgIftar).toLocaleString()}`,sub:`${iftarCov}Ã—${nights}Ã—EGP${avgIftar}`,c:"#7c3aed"},
                    {l:"Suhoor Total",v:`EGP ${(suhoorCov*nights*avgSuhoor).toLocaleString()}`,sub:`${suhoorCov}Ã—${nights}Ã—EGP${avgSuhoor}`,c:"#1e40af"},
                    {l:"Delivery Total",v:`EGP ${(delOrd*avgDel).toLocaleString()}`,sub:`${delOrd}Ã—EGP${avgDel}`,c:"#16653a"},
                    {l:"B2C Total / Branch",v:`EGP ${Math.round(b2cRevPerBranch).toLocaleString()}`,sub:"all B2C sessions",c:"#be185d",bold:true},
                    {l:"B2B Add-on / Branch",v:b2bActive?`EGP ${b2bRevenue.toLocaleString()}`:"OFF",sub:`${b2bCovers} corporate covers`,c:"#d97706"},
                    {l:"Grand Total / Branch",v:`EGP ${Math.round(b2cRevPerBranch+(b2bActive?b2bRevenue:0)).toLocaleString()}`,sub:`EGP ${Math.round(totalRev8/1000)}K Ã— 8 branches`,c:"#be185d",bold:true},
                  ].map((s,i)=>(
                    <div key={i} style={{background:"#fff",borderRadius:6,padding:"10px 12px",border:"1px solid #bbf7d0"}}>
                      <div style={{fontFamily:mono,fontSize:7.5,color:"#999",letterSpacing:1,marginBottom:2}}>{s.l.toUpperCase()}</div>
                      <div style={{fontFamily:disp,fontSize:s.bold?16:14,fontWeight:800,color:s.c}}>{s.v}</div>
                      <div style={{fontFamily:mono,fontSize:7.5,color:"#bbb",marginTop:2}}>{s.sub}</div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* â”€â”€ SECTION 5: LIVE FUNNEL â”€â”€ */}
            <div style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:10,padding:"16px",marginBottom:12}}>
              <div style={{fontFamily:disp,fontSize:14,fontWeight:700,color:"#222",marginBottom:2}}>ðŸ“Š Live Funnel â€” Wired from Channel Actuals</div>
              <div style={{fontFamily:mono,fontSize:8.5,color:"#999",marginBottom:12}}>Aggregated from all active B2C channels above. Update impressions, clicks, and orders per channel to see funnel update.</div>
              <div style={{display:"grid",gridTemplateColumns:"3fr 2fr",gap:12}}>
                <div>
                  {fStages.map((s,i)=>{
                    const prev=i>0?fStages[i-1]:null;
                    const convRate=prev&&prev.val>0?(s.val/prev.val*100).toFixed(1):null;
                    const barW=Math.max((s.val/topFVal)*100,1);
                    return(
                      <div key={i} style={{marginBottom:10}}>
                        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}}>
                          <div style={{display:"flex",alignItems:"center",gap:5}}>
                            <span style={{fontSize:13}}>{s.icon}</span>
                            <span style={{fontFamily:sans,fontSize:10,color:"#555"}}>{s.label}</span>
                          </div>
                          <div style={{display:"flex",alignItems:"center",gap:8}}>
                            {convRate&&<span style={{fontFamily:mono,fontSize:8,color:s.color,background:s.color+"15",padding:"1px 5px",borderRadius:3,fontWeight:700}}>{convRate}% from prev</span>}
                            <span style={{fontFamily:mono,fontSize:12,fontWeight:800,color:s.val>0?s.color:"#ccc"}}>{s.val>0?s.val.toLocaleString():"â€”"}</span>
                          </div>
                        </div>
                        <div style={{height:16,background:"#f0ede8",borderRadius:4,overflow:"hidden"}}>
                          <div style={{height:"100%",width:`${barW}%`,background:s.val>0?s.color:"#e0ddd8",borderRadius:4,transition:"width 0.4s"}}/>
                        </div>
                      </div>
                    );
                  })}
                  <div style={{marginTop:10,padding:"10px 12px",background:"#f9f8f6",borderRadius:6,display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
                    {[
                      {l:"Blended CAC",v:blendedCAC>0?`EGP ${blendedCAC}`:"â€”",c:blendedCAC>0&&blendedCAC<avgIftar*0.3?"#16653a":"#dc2626"},
                      {l:"Overall CTR",v:totalImp>0?`${(totalClicks/totalImp*100).toFixed(2)}%`:"â€”",c:"#1e40af"},
                      {l:"Overall CVR",v:totalClicks>0?`${(totalB2COrders/totalClicks*100).toFixed(1)}%`:"â€”",c:"#7c3aed"},
                    ].map((s,i)=>(
                      <div key={i} style={{textAlign:"center"}}>
                        <div style={{fontFamily:mono,fontSize:7,color:"#bbb",marginBottom:2}}>{s.l}</div>
                        <div style={{fontFamily:disp,fontSize:15,fontWeight:800,color:s.c}}>{s.v}</div>
                      </div>
                    ))}
                  </div>
                </div>
                {/* Conversion benchmarks */}
                <div>
                  <div style={{fontFamily:mono,fontSize:8,color:"#999",letterSpacing:1,marginBottom:8}}>CONVERSION RATES VS F&B BENCHMARK</div>
                  {[
                    {stage:"CTR (Imp â†’ Click)",actual:totalImp>0?(totalClicks/totalImp*100):0,bench:4.0,fmt:v=>`${v.toFixed(2)}%`},
                    {stage:"CVR (Click â†’ Order)",actual:totalClicks>0?(totalB2COrders/totalClicks*100):0,bench:20,fmt:v=>`${v.toFixed(1)}%`},
                    {stage:"Repeat Rate",actual:repRate,bench:30,fmt:v=>`${v}%`},
                  ].map((f,i)=>{
                    const isAbove=f.actual>=f.bench;
                    const c=isAbove?"#16653a":"#dc2626";
                    const max=Math.max(f.actual,f.bench)*1.3||1;
                    return(
                      <div key={i} style={{marginBottom:12}}>
                        <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
                          <span style={{fontFamily:sans,fontSize:10,color:"#555"}}>{f.stage}</span>
                          <span style={{fontFamily:mono,fontSize:9,color:c,fontWeight:700}}>{f.fmt(f.actual)} {isAbove?"â†‘":"â†“"}</span>
                        </div>
                        <div style={{position:"relative",height:8,background:"#f0ede8",borderRadius:3}}>
                          <div style={{position:"absolute",top:0,left:0,height:"100%",width:`${Math.min(f.bench/max*100,100)}%`,background:"#e0ddd8",borderRadius:3}}/>
                          <div style={{position:"absolute",top:1,left:0,height:6,width:`${Math.min(f.actual/max*100,100)}%`,background:c,borderRadius:2,transition:"width 0.3s"}}/>
                        </div>
                        <div style={{fontFamily:mono,fontSize:7.5,color:"#ccc",marginTop:2}}>benchmark: {f.fmt(f.bench)}</div>
                      </div>
                    );
                  })}
                  {/* CAC comparison */}
                  <div style={{marginTop:14,background:"#f9f8f6",borderRadius:8,padding:"10px 12px"}}>
                    <div style={{fontFamily:mono,fontSize:7.5,color:"#999",marginBottom:6}}>CAC BY CHANNEL</div>
                    {chMetrics.filter(m=>m.cac).sort((a,b)=>a.cac-b.cac).map((m,i)=>{
                      const maxCAC=Math.max(...chMetrics.filter(x=>x.cac).map(x=>x.cac),1);
                      return(
                        <div key={i} style={{display:"flex",alignItems:"center",gap:6,marginBottom:5}}>
                          <div style={{width:80,fontFamily:sans,fontSize:8.5,color:"#555",flexShrink:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{m.name}</div>
                          <div style={{flex:1,height:10,background:"#eee",borderRadius:3,overflow:"hidden"}}>
                            <div style={{height:"100%",width:`${(m.cac/maxCAC)*100}%`,background:m.cac<avgIftar*0.3?m.color:"#dc2626",borderRadius:3}}/>
                          </div>
                          <div style={{fontFamily:mono,fontSize:8.5,color:m.cac<avgIftar*0.3?"#16653a":"#dc2626",fontWeight:700,width:55,textAlign:"right"}}>EGP {m.cac}</div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            </div>

            {/* â”€â”€ SECTION 6: INSIGHTS â”€â”€ */}
            <div style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:10,padding:"16px",marginBottom:12}}>
              <div style={{fontFamily:disp,fontSize:14,fontWeight:700,color:"#222",marginBottom:10}}>ðŸ§  Strategic Insights â€” From Your Numbers</div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(260px,1fr))",gap:8}}>
                {[
                  {icon:"ðŸ’¡",c:"#1e40af",title:"CAC Health",
                    text:blendedCAC>0?`Blended B2C CAC is EGP ${blendedCAC} vs avg check EGP ${avgIftar}. CAC/Revenue ratio: ${(blendedCAC/avgIftar*100).toFixed(0)}%. ${blendedCAC<avgIftar*0.3?"Healthy â€” you're acquiring customers at <30% of avg check.":blendedCAC<avgIftar?"Borderline â€” optimise before scaling paid spend.":"âš  CAC exceeds 100% of avg check â€” paid channels losing money."}`:"Enter orders and budget per channel to calculate CAC."},
                  {icon:"ðŸ¢",c:"#d97706",title:"B2B Opportunity",
                    text:b2bActive?`${b2bWonClients} corporate clients Ã— ${groupSize} covers Ã— ${bookings} bookings = ${b2bCovers.toLocaleString()} guaranteed covers at EGP ${pkgPrice}/person. B2B CAC of EGP ${b2bCAC}/client won is ${b2bCAC<pkgPrice*groupSize*0.1?"excellent â€” <10% of contract value":"high â€” renegotiate package pricing or reduce outreach cost"}. B2B adds EGP ${b2bRevenue.toLocaleString()} predictable revenue per branch.`:"Enable B2B toggle to see corporate Iftar pipeline analysis."},
                  {icon:"ðŸ“¡",c:"#16653a",title:"Best Channel",
                    text:(()=>{
                      const best=chMetrics.filter(m=>m.roas).sort((a,b)=>b.roas-a.roas)[0];
                      const worst=chMetrics.filter(m=>m.roas).sort((a,b)=>a.roas-b.roas)[0];
                      if(!best) return "Enter orders per channel to identify your best performer.";
                      return `${best.name} has highest ROAS at ${best.roas.toFixed(1)}Ã— â€” EGP ${best.budget.toLocaleString()} budget driving EGP ${(best.orders*avgIftar).toLocaleString()} revenue.${worst&&worst.k!==best.k&&worst.roas<2?` ${worst.name} at ${worst.roas.toFixed(1)}Ã— is underperforming â€” consider pausing and reallocating EGP ${worst.budget.toLocaleString()} to ${best.name}.`:""}`;
                    })()},
                  {icon:"ðŸ”„",c:"#be185d",title:"Repeat Revenue",
                    text:`At ${repRate}% repeat rate, ${Math.round(totalB2COrders*(repRate/100)).toLocaleString()} customers return this Ramadan. Each 5% improvement = ${Math.round(totalB2COrders*0.05).toLocaleString()} extra orders Ã— EGP ${avgIftar} = EGP ${Math.round(totalB2COrders*0.05*avgIftar*8).toLocaleString()} group revenue at EGP 0 CAC. WhatsApp CRM is your highest-leverage channel for repeat.`},
                  {icon:"ðŸŽ¯",c:"#7c3aed",title:"CVR Gap",
                    text:totalClicks>0?`Current CVR: ${(totalB2COrders/totalClicks*100).toFixed(1)}% vs 20% benchmark. ${(totalB2COrders/totalClicks*100)>=20?"Above benchmark â€” funnel is converting well.":
                    `If you hit 20% CVR on ${totalClicks.toLocaleString()} clicks, you'd get ${Math.round(totalClicks*0.2).toLocaleString()} orders vs current ${totalB2COrders.toLocaleString()} â€” ${Math.round(totalClicks*0.2-totalB2COrders).toLocaleString()} additional orders worth EGP ${Math.round((totalClicks*0.2-totalB2COrders)*avgIftar).toLocaleString()}.`}`:"Enter clicks per channel to see CVR gap analysis."},
                  {icon:"ðŸ’°",c:"#dc2626",title:"ROI Summary",
                    text:`Total spend: EGP ${totalBudget.toLocaleString()}/branch Ã— 8 = EGP ${totalBudget8.toLocaleString()}. Total projected revenue: EGP ${Math.round(totalRev8/1000)}K. Marketing ROI: ${overallROI}Ã—. ${Number(overallROI)>=10?"Excellent â€” Ramadan is delivering strong returns.":Number(overallROI)>=5?"Good â€” on track for a strong Ramadan.":Number(overallROI)>=2?"Acceptable â€” look for channels to optimise.":"âš  Review spend allocation â€” ROI needs improvement."}`},
                ].map((ins,i)=>(
                  <div key={i} style={{background:"#f9f8f6",borderRadius:8,padding:"12px 14px",borderLeft:`3px solid ${ins.c}`}}>
                    <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:5}}>
                      <span style={{fontSize:15}}>{ins.icon}</span>
                      <div style={{fontFamily:disp,fontSize:11,fontWeight:700,color:ins.c}}>{ins.title}</div>
                    </div>
                    <div style={{fontFamily:sans,fontSize:10,color:"#555",lineHeight:1.6}}>{ins.text}</div>
                  </div>
                ))}
              </div>
            </div>

            {/* â”€â”€ SECTION 7: NOTES â”€â”€ */}
            <div style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:10,padding:"16px"}}>
              <div style={{fontFamily:disp,fontSize:13,fontWeight:700,color:"#222",marginBottom:8}}>ðŸ“ Planning Notes</div>
              <textarea value={mktPlan.notes} onChange={e=>setMktPlan(p=>({...p,notes:e.target.value}))}
                placeholder="B2B leads, channel decisions, pricing notes, branch-specific observations..."
                style={{width:"100%",minHeight:80,padding:"10px 12px",border:"1px solid #e5e1dc",borderRadius:6,fontFamily:sans,fontSize:11,color:"#444",resize:"vertical",boxSizing:"border-box",background:"#fafaf8"}}/>
            </div>

          </div>
          );
        })()}

        view==="reqs"&&<div>
          <div style={{fontFamily:mono,fontSize:8,color:"#999",letterSpacing:1.5,marginBottom:8}}>CLIENT-SIDE REQUIREMENTS</div>
          {requirements.map((r,i)=>(
            <div key={i} style={{display:"grid",gridTemplateColumns:"1fr 110px 65px 50px",gap:5,alignItems:"center",padding:"7px 10px",background:"#fff",border:"1px solid #e5e1dc",borderRadius:5,borderLeft:r.critical?"3px solid #dc2626":"3px solid #ddd",marginBottom:2}}>
              <span style={{fontSize:11,fontWeight:600,color:"#333"}}>{r.item}</span>
              <span style={{fontFamily:mono,fontSize:9,color:"#888"}}>{r.who}</span>
              <span style={{fontFamily:mono,fontSize:9,color:r.critical?"#dc2626":"#888",fontWeight:r.critical?700:400}}>{r.due}</span>
              {r.critical?<span style={{fontFamily:mono,fontSize:7,color:"#dc2626",background:"#fef2f2",padding:"1px 3px",borderRadius:2,fontWeight:700,textAlign:"center"}}>CRITICAL</span>:<span/>}
            </div>
          ))}
          <div style={{fontFamily:mono,fontSize:8,color:"#999",letterSpacing:1.5,marginTop:14,marginBottom:8}}>CRITICAL HIRES</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginBottom:14}}>
            {[{role:"Cost Controller",resp:"Food cost, recipe validation, variance analysis, stock-take oversight",by:"Week 1"},{role:"Chief Accountant",resp:"Consolidated P&L, financial position, bank reconciliation",by:"Week 1â€“2"}].map((h,i)=>(
              <div key={i} style={{background:"#fff",border:"1px solid #fca5a5",borderRadius:8,padding:"10px 12px"}}>
                <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
                  <span style={{fontFamily:disp,fontSize:12,fontWeight:700}}>{h.role}</span>
                  <span style={{fontFamily:mono,fontSize:8,color:"#dc2626",fontWeight:700}}>BY {h.by.toUpperCase()}</span>
                </div>
                <div style={{fontSize:10,color:"#888",lineHeight:1.4}}>{h.resp}</div>
              </div>
            ))}
          </div>
          <div style={{fontFamily:mono,fontSize:8,color:"#999",letterSpacing:1.5,marginBottom:8}}>KEY TERMS</div>
          <div style={{background:"#fff",border:"1px solid #e5e1dc",borderRadius:8,padding:"12px 14px"}}>
            {["Valid 30 days","Deliverables become Abou Shakra IP upon payment","Scope changes quoted as addenda","Strictly confidential","14 days notice to terminate; retainer prorated","Unimpeded access to systems & personnel required","Client delays extend timeline proportionally","Monthly retainer based on hours with EGP 100K minimum"].map((t,i)=>(
              <div key={i} style={{display:"flex",gap:5,padding:"3px 0",borderBottom:i<7?"1px solid #f0f0ee":"none"}}>
                <span style={{fontFamily:mono,fontSize:9,color:"#D4863A"}}>Â§{i+1}</span>
                <span style={{fontSize:10.5,color:"#666",lineHeight:1.5}}>{t}</span>
              </div>
            ))}
          </div>
        </div>}

        <div style={{marginTop:20,paddingTop:12,borderTop:"1px solid #e5e1dc",display:"flex",justifyContent:"space-between"}}>
          <div style={{display:"flex",alignItems:"center",gap:4}}><span style={{fontFamily:disp,fontSize:11,fontWeight:300,color:"#bbb"}}>C^2</span><span style={{fontFamily:mono,fontSize:7.5,color:"#ccc",letterSpacing:2}}>FRACTIONAL MANAGEMENT</span></div>
          <span style={{fontFamily:mono,fontSize:7.5,color:"#ccc"}}>QT-AS-2026-001 Â· Confidential</span>
        </div>
      </div>

      {/* â”€â”€â”€ ADD TASK MODAL â”€â”€â”€ */}
      {showAddTask&&<div className="modal-overlay" onClick={()=>setShowAddTask(false)}>
        <div className="modal-box" onClick={e=>e.stopPropagation()}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
            <div style={{fontFamily:disp,fontSize:16,fontWeight:700}}>Add Custom Task</div>
            <button onClick={()=>setShowAddTask(false)} style={{background:"none",border:"none",fontSize:18,color:"#999",cursor:"pointer"}}>âœ•</button>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
            <div style={{gridColumn:"1/-1"}}>
              <div style={labelStyle}>TASK NAME *</div>
              <input value={newTask.name} onChange={e=>setNewTask(p=>({...p,name:e.target.value}))} style={{...inputStyle,fontSize:13}} placeholder="e.g. Cash flow forecast model"/>
            </div>
            <div>
              <div style={labelStyle}>BUCKET</div>
              <select value={newTask.b} onChange={e=>setNewTask(p=>({...p,b:e.target.value}))} style={{...inputStyle,padding:"6px 7px"}}>
                {buckets.map(b=><option key={b.id} value={b.id}>{b.id} â€“ {b.name}</option>)}
              </select>
            </div>
            <div>
              <div style={labelStyle}>DEPARTMENT</div>
              <select value={newTask.dept} onChange={e=>setNewTask(p=>({...p,dept:e.target.value}))} style={{...inputStyle,padding:"6px 7px"}}>
                {Object.entries(D).map(([k,v])=><option key={k} value={k}>{v.l}</option>)}
              </select>
            </div>
            <div>
              <div style={labelStyle}>TIER</div>
              <select value={newTask.tier} onChange={e=>setNewTask(p=>({...p,tier:e.target.value}))} style={{...inputStyle,padding:"6px 7px"}}>
                {Object.entries(T).map(([k,v])=><option key={k} value={k}>{v.ico} {v.l}</option>)}
              </select>
            </div>
            <div>
              <div style={labelStyle}>PRIORITY</div>
              <select value={newTask.prio} onChange={e=>setNewTask(p=>({...p,prio:e.target.value}))} style={{...inputStyle,padding:"6px 7px"}}>
                {Object.entries(PRIO).map(([k,v])=><option key={k} value={k}>{v.ico} {v.l}</option>)}
              </select>
            </div>
            <div>
              <div style={labelStyle}>IMPACT</div>
              <select value={newTask.impact} onChange={e=>setNewTask(p=>({...p,impact:e.target.value}))} style={{...inputStyle,padding:"6px 7px"}}>
                {Object.entries(IMP).map(([k,v])=><option key={k} value={k}>{v.l}</option>)}
              </select>
            </div>
            <div>
              <div style={labelStyle}>HOURS</div>
              <input type="number" min="1" value={newTask.hrs} onChange={e=>setNewTask(p=>({...p,hrs:Number(e.target.value)}))} style={inputStyle}/>
            </div>
            <div>
              <div style={labelStyle}>WEEK START</div>
              <select value={newTask.w[0]} onChange={e=>setNewTask(p=>({...p,w:[Number(e.target.value),Math.max(Number(e.target.value),p.w[1])]}))} style={{...inputStyle,padding:"6px 7px"}}>
                {WEEKS.map(w=><option key={w} value={w}>Week {w}</option>)}
              </select>
            </div>
            <div>
              <div style={labelStyle}>WEEK END</div>
              <select value={newTask.w[1]} onChange={e=>setNewTask(p=>({...p,w:[p.w[0],Number(e.target.value)]}))} style={{...inputStyle,padding:"6px 7px"}}>
                {WEEKS.filter(w=>w>=newTask.w[0]).map(w=><option key={w} value={w}>Week {w}</option>)}
              </select>
            </div>
            <div style={{gridColumn:"1/-1"}}>
              <div style={labelStyle}>DESCRIPTION</div>
              <textarea value={newTask.desc} onChange={e=>setNewTask(p=>({...p,desc:e.target.value}))} rows={2} style={{...inputStyle,resize:"vertical"}} placeholder="What does this task deliver?"/>
            </div>
            <div>
              <div style={labelStyle}>P&L IMPACT</div>
              <input value={newTask.pnl} onChange={e=>setNewTask(p=>({...p,pnl:e.target.value}))} style={inputStyle} placeholder="Effect on P&L"/>
            </div>
            <div>
              <div style={labelStyle}>BALANCE SHEET IMPACT</div>
              <input value={newTask.bs} onChange={e=>setNewTask(p=>({...p,bs:e.target.value}))} style={inputStyle} placeholder="Effect on BS"/>
            </div>
            <div style={{gridColumn:"1/-1"}}>
              <div style={labelStyle}>CASH FLOW IMPACT</div>
              <input value={newTask.cf} onChange={e=>setNewTask(p=>({...p,cf:e.target.value}))} style={inputStyle} placeholder="Effect on cash flow"/>
            </div>
          </div>
          <div style={{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16}}>
            <button onClick={()=>setShowAddTask(false)} style={{padding:"8px 16px",background:"#f5f3f0",border:"1px solid #e5e1dc",borderRadius:6,fontSize:12,cursor:"pointer",fontFamily:sans}}>Cancel</button>
            <button onClick={addTask} disabled={!newTask.name} style={{padding:"8px 16px",background:newTask.name?"#16653a":"#ccc",color:"#fff",border:"none",borderRadius:6,fontSize:12,fontWeight:700,cursor:newTask.name?"pointer":"default",fontFamily:sans}}>Add Task</button>
          </div>
        </div>
      </div>}

      {/* â”€â”€â”€ ADD COMMENT MODAL â”€â”€â”€ */}
      {showAddComment&&<div className="modal-overlay" onClick={()=>setShowAddComment(false)}>
        <div className="modal-box" onClick={e=>e.stopPropagation()}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
            <div style={{fontFamily:disp,fontSize:16,fontWeight:700}}>Add Comment / Action Item</div>
            <button onClick={()=>setShowAddComment(false)} style={{background:"none",border:"none",fontSize:18,color:"#999",cursor:"pointer"}}>âœ•</button>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
            <div>
              <div style={labelStyle}>YOUR NAME *</div>
              <input value={newComment.author} onChange={e=>setNewComment(p=>({...p,author:e.target.value}))} style={inputStyle} placeholder="e.g. Ahmed / Moustafa"/>
            </div>
            <div>
              <div style={labelStyle}>TYPE</div>
              <select value={newComment.type} onChange={e=>setNewComment(p=>({...p,type:e.target.value}))} style={{...inputStyle,padding:"6px 7px"}}>
                <option value="comment">ðŸ’¬ Comment</option>
                <option value="action">âœ… Action Item</option>
                <option value="risk">âš ï¸ Risk / Blocker</option>
                <option value="decision">ðŸŽ¯ Decision</option>
              </select>
            </div>
            <div style={{gridColumn:"1/-1"}}>
              <div style={labelStyle}>CONTENT *</div>
              <textarea value={newComment.content} onChange={e=>setNewComment(p=>({...p,content:e.target.value}))} rows={3} style={{...inputStyle,resize:"vertical"}} placeholder="What needs to be noted or actioned?"/>
            </div>
            <div>
              <div style={labelStyle}>RELATED TASK (OPTIONAL)</div>
              <select value={newComment.task} onChange={e=>setNewComment(p=>({...p,task:e.target.value}))} style={{...inputStyle,padding:"6px 7px"}}>
                <option value="">â€” None â€”</option>
                {tasks.map(t=><option key={t.id} value={`#${t.id} ${t.name}`}>#{t.id} {t.name}</option>)}
              </select>
            </div>
            <div>
              <div style={labelStyle}>STATUS</div>
              <select value={newComment.status} onChange={e=>setNewComment(p=>({...p,status:e.target.value}))} style={{...inputStyle,padding:"6px 7px"}}>
                <option value="Open">Open</option>
                <option value="Resolved">Resolved</option>
              </select>
            </div>
          </div>
          <div style={{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16}}>
            <button onClick={()=>setShowAddComment(false)} style={{padding:"8px 16px",background:"#f5f3f0",border:"1px solid #e5e1dc",borderRadius:6,fontSize:12,cursor:"pointer",fontFamily:sans}}>Cancel</button>
            <button onClick={addComment} disabled={!newComment.author||!newComment.content} style={{padding:"8px 16px",background:(newComment.author&&newComment.content)?"#1e40af":"#ccc",color:"#fff",border:"none",borderRadius:6,fontSize:12,fontWeight:700,cursor:(newComment.author&&newComment.content)?"pointer":"default",fontFamily:sans}}>Add</button>
          </div>
        </div>
      </div>}

      {/* â•â•â• CLAUDE AGENT â•â•â• */}
      <AgentWidget
        mktPlan={mktPlan} tasks={tasks} view={view}
        updMktCh={updMktCh} updMktB2B={updMktB2B} updMktPricing={updMktPricing}
        setTasks={setTasks} setView={setView}
      />


      </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(App));

</script>
</body>
</html>
